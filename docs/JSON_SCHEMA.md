# CoreGuard JSON Report Schema

**Schema Version:** `1.0`

This document describes the JSON report format generated by `coreguard compare` and consumed by the WASM-based viewer.

## Root Structure

```json
{
  "_version": "1.0",
  "reference": { ... },
  "samples": { ... },
  "pipelines": { ... },
  "data": { ... },
  "polymorphic_sites": { ... },
  "summary": { ... }
}
```

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `_version` | string | Yes | Schema version (currently "1.0") |
| `reference` | object | Yes | Reference genome information |
| `samples` | object | Yes | Sample metadata (sample_id → info) |
| `pipelines` | object | Yes | Pipeline metadata (pipeline_id → info) |
| `data` | object | Yes | SNP/gap data (sample_id → pipeline_id → data) |
| `polymorphic_sites` | object | No | Polymorphic sites for distance matrix (pipeline_id → position → site) |
| `summary` | object | Yes | Summary statistics and metadata |

---

## Reference Object

```json
{
  "name": "NC_003197.2",
  "label": "Salmonella LT2",
  "length": 4857432,
  "sequence": "AGCTTTTCATTCTGA..."
}
```

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `name` | string | Yes | Reference sequence name (from FASTA header) |
| `label` | string | No | Human-readable label |
| `length` | integer | Yes | Reference length in bp |
| `sequence` | string | Yes | Full reference sequence (uppercase A/C/G/T/N) |

---

## Samples Object

Map of sample_id → sample metadata:

```json
{
  "sample1": { "label": "Sample 1 (2024)" },
  "sample2": { "label": null }
}
```

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `label` | string | No | Human-readable label for display |

---

## Pipelines Object

Map of pipeline_id → pipeline metadata:

```json
{
  "snippy": {
    "label": "Snippy v4.6",
    "command": "snippy --ref ref.fa --outdir out sample.fastq.gz",
    "has_vcf": true,
    "has_bam": true,
    "ground_truth": false
  },
  "ground_truth": {
    "label": "Ground Truth (BAM Pileup)",
    "has_vcf": false,
    "has_bam": true,
    "ground_truth": true
  }
}
```

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `label` | string | No | Human-readable label |
| `command` | string | No | Command used to run the pipeline |
| `has_vcf` | boolean | Yes | Whether VCF data is available |
| `has_bam` | boolean | Yes | Whether BAM data is available |
| `ground_truth` | boolean | No | Whether this is the ground truth baseline (default: false) |

---

## Data Object

Nested map: sample_id → pipeline_id → pipeline data:

```json
{
  "sample1": {
    "snippy": {
      "gaps": [[100, 200], [500, 550]],
      "snps": [
        { "pos": 1234, "ref": "A", "alt": "G", "qual": 200.0, "dp": 45 }
      ],
      "vcf_path": "/path/to/sample1.vcf.gz",
      "bam_path": "/path/to/sample1.bam"
    }
  }
}
```

### Pipeline Data

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `gaps` | array | No | Gap regions as `[start, end)` pairs (1-based, half-open) |
| `snps` | array | No | SNP calls |
| `vcf_path` | string | No | Source VCF file path |
| `bam_path` | string | No | Source BAM file path |

### SNP Object

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `pos` | integer | Yes | Position (1-based) |
| `ref` | string | Yes | Reference allele |
| `alt` | string | Yes | Alternate allele |
| `qual` | number | Yes | Quality score from VCF |
| `dp` | integer | Yes | Read depth |

---

## Polymorphic Sites Object

Map of pipeline_id → position → polymorphic site data. Used for distance matrix calculation.

```json
{
  "snippy": {
    "1234": {
      "ref": "A",
      "alleles": {
        "sample1": { "base": "G", "source": "vcf", "depth": 45, "qual": 200.0 },
        "sample2": { "base": "A", "source": "bam", "depth": 32, "consensus": 0.95 }
      }
    }
  }
}
```

### Polymorphic Site

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `ref` | char | Yes | Reference allele at this position |
| `alleles` | object | Yes | Sample alleles (sample_id → allele info) |

### Sample Allele

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `base` | char | Yes | Called base (A/C/G/T/N) |
| `source` | string | Yes | Call source: `"vcf"`, `"bam"`, or `"gap"` |
| `depth` | integer | No | Read depth at this position |
| `qual` | number | No | Quality score (from VCF) |
| `consensus` | number | No | Consensus percentage 0.0-1.0 (from BAM) |

---

## Summary Object

```json
{
  "total_samples": 10,
  "total_pipelines": 3,
  "generated_at": "2024-01-15T10:30:00Z",
  "coreguard_version": "0.1.0",
  "warnings": ["MNP decomposition: 5 MNPs split into 12 SNPs for snippy"],
  "snps_in_gt_gaps": { ... },
  "ground_truth_pileup": { ... },
  "mnp_stats": { ... }
}
```

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `total_samples` | integer | Yes | Number of samples |
| `total_pipelines` | integer | Yes | Number of pipelines |
| `generated_at` | string | Yes | ISO 8601 timestamp |
| `coreguard_version` | string | Yes | CoreGuard version |
| `warnings` | array | No | Warning messages |
| `snps_in_gt_gaps` | object | No | SNPs in ground truth gaps stats |
| `ground_truth_pileup` | object | No | Ground truth pileup statistics |
| `mnp_stats` | object | No | MNP decomposition statistics |

---

### SNPs in Ground Truth Gaps

Map of pipeline_id → stats:

```json
{
  "snippy": {
    "total_snps": 1500,
    "snps_in_gaps": 45,
    "percentage": 3.0
  }
}
```

| Field | Type | Description |
|-------|------|-------------|
| `total_snps` | integer | Total SNPs called by this pipeline |
| `snps_in_gaps` | integer | SNPs falling within ground truth gap regions |
| `percentage` | number | Percentage of SNPs in gaps |

---

### Ground Truth Pileup Statistics

```json
{
  "total_snps": 493451,
  "per_sample": {
    "sample1": 12345,
    "sample2": 11234
  },
  "covered_positions": 4800000,
  "pipeline_comparison": {
    "snippy": {
      "pipeline_snps": 125000,
      "ground_truth_snps": 493451,
      "difference": -368451,
      "percentage_diff": -74.7
    }
  }
}
```

| Field | Type | Description |
|-------|------|-------------|
| `total_snps` | integer | Total SNPs from BAM pileup (sum across all samples) |
| `per_sample` | object | SNP count per sample (sample_id → count) |
| `covered_positions` | integer | Positions with sufficient coverage for calling |
| `pipeline_comparison` | object | VCF pipeline vs GT comparison |

### Pipeline vs Ground Truth Comparison

| Field | Type | Description |
|-------|------|-------------|
| `pipeline_snps` | integer | SNPs called by this pipeline (from VCF) |
| `ground_truth_snps` | integer | SNPs from ground truth BAM pileup |
| `difference` | integer | Difference (pipeline - ground_truth) |
| `percentage_diff` | number | Percentage difference |

---

### MNP Statistics

Map of pipeline_id → stats:

```json
{
  "snippy": {
    "mnps_found": 5,
    "snps_from_mnps": 12
  }
}
```

| Field | Type | Description |
|-------|------|-------------|
| `mnps_found` | integer | Number of MNPs (multi-nucleotide polymorphisms) found and decomposed |
| `snps_from_mnps` | integer | Total individual SNPs resulting from MNP decomposition |

---

## Example

Minimal valid report:

```json
{
  "_version": "1.0",
  "reference": {
    "name": "ref",
    "length": 1000,
    "sequence": "ACGT..."
  },
  "samples": {
    "sample1": {}
  },
  "pipelines": {
    "snippy": {
      "has_vcf": true,
      "has_bam": true
    }
  },
  "data": {
    "sample1": {
      "snippy": {
        "snps": [
          { "pos": 100, "ref": "A", "alt": "G", "qual": 200.0, "dp": 50 }
        ]
      }
    }
  },
  "summary": {
    "total_samples": 1,
    "total_pipelines": 1,
    "generated_at": "2024-01-15T10:00:00Z",
    "coreguard_version": "0.1.0"
  }
}
```

---

## Changelog

### Version 1.0 (Current)

- Initial schema version
- Support for VCF-based SNP calls and BAM-based gap detection
- Polymorphic sites for distance matrix calculation
- Ground truth pipeline support with BAM pileup statistics
- MNP decomposition tracking
- SNPs in ground truth gaps analysis
