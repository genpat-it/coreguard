# CoreGuard JSON Report Schema

**Schema Version:** `2.0`

This document describes the JSON report format generated by `coreguard compare` and consumed by the web viewer.

## Output Modes

CoreGuard supports two output modes:

| Mode | Flag | Description |
|------|------|-------------|
| **Full** | (default) | Includes all data including raw gaps/SNPs |
| **Dashboard** | `--dashboard` | Omits raw data, keeps only pre-computed statistics (10-100x smaller) |

In dashboard mode, the `data` field is omitted but all pre-computed statistics remain available.

---

## Root Structure

```json
{
  "_version": "2.0",
  "reference": { ... },
  "samples": { ... },
  "pipelines": { ... },
  "data": { ... },
  "kpis": { ... },
  "pipeline_stats": { ... },
  "summary": { ... },
  "description": "...",
  "pipeline_distance_matrices": { ... },
  "gt_disc_vs_pipelines": [ ... ],
  "config_yaml": "..."
}
```

| Field | Type | Required | Dashboard | Description |
|-------|------|----------|-----------|-------------|
| `_version` | string | Yes | Yes | Schema version ("2.0") |
| `reference` | object | Yes | Yes | Reference genome information |
| `samples` | object | Yes | Yes | Sample metadata (sample_id → info) |
| `pipelines` | object | Yes | Yes | Pipeline metadata (pipeline_id → info) |
| `data` | object | No | **Omitted** | Raw SNP/gap data (sample_id → pipeline_id → data) |
| `kpis` | object | No | Yes | Pre-computed KPIs per pipeline |
| `pipeline_stats` | object | No | Yes | Pre-computed global/pairwise statistics |
| `summary` | object | Yes | Yes | Summary statistics and metadata |
| `description` | string | No | Yes | Project description (Markdown) |
| `pipeline_distance_matrices` | object | No | Yes | Pre-computed distance matrices |
| `gt_disc_vs_pipelines` | array | No | Yes | GT discriminating SNPs vs pipeline results |
| `config_yaml` | string | No | Yes | Raw YAML configuration |

---

## Reference Object

```json
{
  "name": "CP014790.1",
  "label": "L. monocytogenes CFSAN023463",
  "length": 2894716,
  "sequence": "AGCTTTTCATTCTGA..."
}
```

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `name` | string | Yes | Reference sequence name (from FASTA header) |
| `label` | string | No | Human-readable label |
| `length` | integer | Yes | Reference length in bp |
| `sequence` | string | Yes | Full reference sequence (uppercase A/C/G/T/N) |

---

## Samples Object

Map of sample_id → sample metadata:

```json
{
  "sample1": { "label": "Sample 1 (2024)" },
  "sample2": { "label": null }
}
```

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `label` | string | No | Human-readable label for display |

---

## Pipelines Object

Map of pipeline_id → pipeline metadata:

```json
{
  "snippy": {
    "label": "Snippy v4.6",
    "command": "snippy --ref ref.fa --outdir out sample.fastq.gz",
    "has_vcf": true,
    "has_bam": true,
    "reference": false,
    "from_bam_pileup": false
  },
  "mm2": {
    "label": "Reference (minimap2)",
    "has_vcf": false,
    "has_bam": true,
    "reference": true,
    "from_bam_pileup": true
  }
}
```

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `label` | string | No | Human-readable label |
| `command` | string | No | Command used to run the pipeline |
| `has_vcf` | boolean | Yes | Whether VCF data is available |
| `has_bam` | boolean | Yes | Whether BAM data is available |
| `reference` | boolean | No | Whether this is the reference/ground truth pipeline (default: false) |
| `from_bam_pileup` | boolean | No | Whether SNPs were derived from BAM pileup (default: false) |

---

## Data Object (Full Mode Only)

**Note:** This field is omitted in dashboard mode.

Nested map: sample_id → pipeline_id → pipeline data:

```json
{
  "sample1": {
    "snippy": {
      "gaps": [[100, 200], [500, 550]],
      "snps": [
        { "pos": 1234, "ref": "A", "alt": "G", "qual": 200.0, "dp": 45 }
      ],
      "vcf_path": "/path/to/sample1.vcf.gz",
      "bam_path": "/path/to/sample1.bam"
    }
  }
}
```

### Pipeline Data

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `gaps` | array | No | Gap regions as `[start, end)` pairs (1-based, half-open) |
| `snps` | array | No | SNP calls |
| `vcf_path` | string | No | Source VCF file path |
| `bam_path` | string | No | Source BAM file path |

### SNP Object

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `pos` | integer | Yes | Position (1-based) |
| `ref` | string | Yes | Reference allele |
| `alt` | string | Yes | Alternate allele |
| `qual` | number | Yes | Quality score from VCF |
| `dp` | integer | Yes | Read depth |

---

## KPIs Object

Pre-computed KPIs for all pipelines:

```json
{
  "pipelines": {
    "snippy": {
      "total_snps": 758,
      "total_gap_positions": 12345,
      "core_snps": 756
    }
  }
}
```

### Pipeline KPI

| Field | Type | Description |
|-------|------|-------------|
| `total_snps` | integer | Number of SNP positions (any sample has SNP) |
| `total_gap_positions` | integer | Number of gap positions across all samples |
| `core_snps` | integer | Discriminating SNPs (positions where samples differ) |

---

## Pipeline Stats Object

Pre-computed per-pipeline statistics:

```json
{
  "snippy": {
    "global": { ... },
    "pairwise": { ... }
  }
}
```

### Global Pipeline Stats

```json
{
  "ref_length": 2894716,
  "gap_intersect_count": 0,
  "gap_union_count": 12345,
  "usable_intersect": 2894716,
  "usable_union": 2882371,
  "total_snps_intersect": 758,
  "total_snps_union": 756,
  "consensus_snps_intersect": 2,
  "consensus_snps_union": 0,
  "disc_snps_intersect": 756,
  "disc_snps_union": 756,
  "missing_vcf_intersect": 0,
  "missing_vcf_union": 0,
  "disc_breakdown": {
    "gap_affected": 0,
    "gt_consensus": 10,
    "majority_rule": 5,
    "confirmed": 741
  }
}
```

| Field | Type | Description |
|-------|------|-------------|
| `ref_length` | integer | Reference genome length |
| `gap_intersect_count` | integer | Positions where ALL samples have gap |
| `gap_union_count` | integer | Positions where ANY sample has gap |
| `usable_intersect` | integer | ref_length - gap_intersect_count |
| `usable_union` | integer | ref_length - gap_union_count |
| `total_snps_intersect` | integer | SNPs in usable space (gap-intersect) |
| `total_snps_union` | integer | SNPs in usable space (gap-union) |
| `consensus_snps_intersect` | integer | All samples agree on alt (gap-intersect) |
| `consensus_snps_union` | integer | All samples agree on alt (gap-union) |
| `disc_snps_intersect` | integer | Samples differ (gap-intersect) |
| `disc_snps_union` | integer | Samples differ (gap-union) |
| `missing_vcf_intersect` | integer | Some samples have call, others don't (gap-intersect) |
| `missing_vcf_union` | integer | Some samples have call, others don't (gap-union) |
| `disc_breakdown` | object | Optional breakdown of discriminating SNPs |

### Discriminating SNP Breakdown

| Field | Type | Description |
|-------|------|-------------|
| `gap_affected` | integer | At least one sample skipped due to gap |
| `gt_consensus` | integer | Reference alignment shows all samples agree |
| `majority_rule` | integer | All but one sample agree |
| `confirmed` | integer | Genuine disagreement between samples |

### Pairwise Pipeline Stats

```json
{
  "num_pairs": 1378,
  "disc_snps_min": 0,
  "disc_snps_median": 12.0,
  "disc_snps_max": 45,
  "disc_snps_avg": 14.5,
  "usable_space_avg": 2880000.0,
  "per_sample": {
    "sample1": {
      "avg_usable_space": 2879500.0,
      "avg_disc_snps": 15.2,
      "pairs": {
        "sample2": { "usable_space": 2880000, "disc_snps": 12 },
        "sample3": { "usable_space": 2879000, "disc_snps": 18 }
      }
    }
  }
}
```

| Field | Type | Description |
|-------|------|-------------|
| `num_pairs` | integer | Total number of sample pairs |
| `disc_snps_min` | integer | Minimum discriminating SNPs across pairs |
| `disc_snps_median` | number | Median discriminating SNPs |
| `disc_snps_max` | integer | Maximum discriminating SNPs |
| `disc_snps_avg` | number | Average discriminating SNPs |
| `usable_space_avg` | number | Average usable space across pairs |
| `per_sample` | object | Per-sample pairwise statistics |

---

## Pipeline Distance Matrices Object

Pre-computed distance matrices from pipeline outputs:

```json
{
  "snippy": {
    "samples": ["sample1", "sample2", "sample3"],
    "matrix": [
      [0, 5, 10],
      [5, 0, 8],
      [10, 8, 0]
    ]
  }
}
```

| Field | Type | Description |
|-------|------|-------------|
| `samples` | array | Sample IDs in row/column order |
| `matrix` | array | 2D distance matrix (samples[i] vs samples[j]) |

---

## GT Disc vs Pipelines Array

Comparison of reference (ground truth) discriminating SNPs vs each pipeline:

```json
[
  {
    "pipeline_id": "snippy",
    "pl_total_core_snps": 758,
    "pl_discriminating_core_snps": 756,
    "gap_intersect": {
      "gt_disc": 462,
      "same_pos": 420,
      "concordant": 418,
      "pl_snps_in_gt_gaps": 5,
      "position_details": [ ... ]
    },
    "gap_union": {
      "gt_disc": 450,
      "same_pos": 410,
      "concordant": 408,
      "pl_snps_in_gt_gaps": 3,
      "position_details": [ ... ]
    },
    "pairwise": {
      "gt_disc_avg": 15.2,
      "same_pos_avg": 14.5,
      "concordant_avg": 14.2,
      "num_pairs": 1378
    }
  }
]
```

### GT Disc vs Pipeline Result

| Field | Type | Description |
|-------|------|-------------|
| `pipeline_id` | string | Pipeline identifier |
| `pl_total_core_snps` | integer | Total core SNP positions in pipeline |
| `pl_discriminating_core_snps` | integer | Discriminating positions in pipeline |
| `gap_intersect` | object | Results using gap-intersect strategy |
| `gap_union` | object | Results using gap-union strategy |
| `pairwise` | object | Pairwise averages |

### Gap Strategy Result

| Field | Type | Description |
|-------|------|-------------|
| `gt_disc` | integer | GT discriminating positions |
| `same_pos` | integer | GT disc positions also in pipeline |
| `concordant` | integer | Same_pos with matching alleles (null if no allele data) |
| `pl_snps_in_gt_gaps` | integer | Pipeline SNPs falling in GT gaps |
| `position_details` | array | Per-position drill-down data (optional) |

### Position Detail

```json
{
  "pos": 12345,
  "ref": "A",
  "gt": { "sample1": "A", "sample2": "G", "sample3": "A" },
  "pl": { "sample1": "A", "sample2": "G", "sample3": "A" },
  "status": "concordant"
}
```

| Field | Type | Description |
|-------|------|-------------|
| `pos` | integer | Genomic position (1-based) |
| `ref` | string | Reference allele |
| `gt` | object | Sample → GT allele ("-" if in gap) |
| `pl` | object | Sample → Pipeline allele ("-" if in gap) |
| `status` | string | Status: concordant, discordant, not_disc_in_pl, lost, in_gt_gap, in_pl_gap, pl_only |

---

## Summary Object

```json
{
  "total_samples": 53,
  "total_pipelines": 3,
  "generated_at": "2024-01-15T10:30:00Z",
  "coreguard_version": "0.1.0",
  "warnings": ["Detected 5 MNP(s) which were automatically decomposed into 12 individual SNPs"],
  "pileup_options": {
    "min_depth": 1,
    "min_qual": 0.0,
    "min_consensus": 0.8,
    "include_indels": false
  }
}
```

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `total_samples` | integer | Yes | Number of samples |
| `total_pipelines` | integer | Yes | Number of pipelines |
| `generated_at` | string | Yes | ISO 8601 timestamp |
| `coreguard_version` | string | Yes | CoreGuard version |
| `warnings` | array | No | Warning messages |
| `pileup_options` | object | No | Pileup options used for reference computation |

---

## Minimal Example (Dashboard Mode)

```json
{
  "_version": "2.0",
  "reference": {
    "name": "ref",
    "length": 1000,
    "sequence": "ACGT..."
  },
  "samples": {
    "sample1": {},
    "sample2": {}
  },
  "pipelines": {
    "snippy": {
      "has_vcf": true,
      "has_bam": true,
      "reference": false
    },
    "mm2": {
      "has_vcf": false,
      "has_bam": true,
      "reference": true
    }
  },
  "kpis": {
    "pipelines": {
      "snippy": { "total_snps": 10, "total_gap_positions": 50, "core_snps": 8 }
    }
  },
  "pipeline_stats": {
    "snippy": {
      "global": { ... },
      "pairwise": { ... }
    }
  },
  "summary": {
    "total_samples": 2,
    "total_pipelines": 2,
    "generated_at": "2024-01-15T10:00:00Z",
    "coreguard_version": "0.1.0"
  }
}
```

---

## Changelog

### Version 2.0 (Current)

- Added `--dashboard` mode support (omits `data` field)
- Added `kpis` - pre-computed KPIs per pipeline
- Added `pipeline_stats` - pre-computed global and pairwise statistics
- Added `pipeline_distance_matrices` - pre-computed distance matrices
- Added `gt_disc_vs_pipelines` - GT discriminating SNPs vs pipeline comparison
- Added `config_yaml` - raw YAML configuration
- Added `description` - project description (Markdown)
- Renamed `ground_truth` → `reference` in pipeline info
- Added `from_bam_pileup` to pipeline info
- Added `pileup_options` to summary
- Removed `polymorphic_sites` (replaced by pre-computed stats)

### Version 1.0 (Deprecated)

- Initial schema version
- Required WASM for KPI computation
