<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CoreGuard SNP Comparison Viewer</title>
    <style>
        :root {
            /* Dark theme (default) */
            --bg-primary: #1e1e1e;
            --bg-secondary: #252526;
            --bg-tertiary: #3c3c3c;
            --text-primary: #d4d4d4;
            --text-secondary: #808080;
            --text-muted: #555;
            --border-color: #3c3c3c;
            --accent: #569cd6;
            --accent-hover: #1177bb;
            --btn-bg: #3c3c3c;
            --btn-border: #555;
            --label-color: #9cdcfe;
            --ref-color: #6a9955;
            --snp-consensus: #4ec9b0;
            --snp-consensus-bg: rgba(78, 201, 176, 0.2);
            --snp-uncertain: #dcdcaa;
            --snp-uncertain-bg: rgba(220, 220, 170, 0.2);
            --snp-discord: #f44747;
            --snp-discord-bg: rgba(244, 71, 71, 0.2);
            --snp-pipeline: #ce9178;
            --snp-pipeline-bg: rgba(206, 145, 120, 0.2);
            --snp-vcf: #569cd6;
            --snp-vcf-bg: rgba(86, 156, 214, 0.2);
            --snp-bam: #b5cea8;
            --snp-bam-bg: rgba(181, 206, 168, 0.2);
            --gap-color: #f44747;
            --gap-bg: rgba(244, 71, 71, 0.1);
        }
        [data-theme="light"] {
            --bg-primary: #ffffff;
            --bg-secondary: #f5f5f5;
            --bg-tertiary: #e0e0e0;
            --text-primary: #333333;
            --text-secondary: #666666;
            --text-muted: #999999;
            --border-color: #cccccc;
            --accent: #0066cc;
            --accent-hover: #0055aa;
            --btn-bg: #e8e8e8;
            --btn-border: #cccccc;
            --label-color: #0066cc;
            --ref-color: #228b22;
            --snp-consensus: #008080;
            --snp-consensus-bg: rgba(0, 128, 128, 0.15);
            --snp-uncertain: #b8860b;
            --snp-uncertain-bg: rgba(184, 134, 11, 0.15);
            --snp-discord: #cc0000;
            --snp-discord-bg: rgba(204, 0, 0, 0.15);
            --snp-pipeline: #8b4513;
            --snp-pipeline-bg: rgba(139, 69, 19, 0.15);
            --snp-vcf: #0066cc;
            --snp-vcf-bg: rgba(0, 102, 204, 0.15);
            --snp-bam: #228b22;
            --snp-bam-bg: rgba(34, 139, 34, 0.15);
            --gap-color: #cc0000;
            --gap-bg: rgba(204, 0, 0, 0.1);
        }
        * {
            box-sizing: border-box;
        }
        body {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            margin: 0;
            padding: 0;
            background: var(--bg-primary);
            color: var(--text-primary);
            transition: background 0.3s, color 0.3s;
        }
        .header {
            background: var(--bg-secondary);
            padding: 12px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header h1 {
            margin: 0;
            font-size: 18px;
            color: var(--accent);
        }
        .header .info {
            font-size: 12px;
            color: var(--text-secondary);
        }
        .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .theme-toggle {
            position: relative;
            width: 44px;
            height: 22px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 11px;
            cursor: pointer;
            transition: background 0.3s ease;
            padding: 0;
        }
        .theme-toggle::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 16px;
            height: 16px;
            background: var(--text-secondary);
            border-radius: 50%;
            transition: transform 0.3s ease, background 0.3s ease;
        }
        .theme-toggle.light::after {
            transform: translateX(22px);
            background: #ffc107;
        }
        .theme-toggle:hover {
            border-color: var(--accent-color);
        }
        .drop-zone {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 60vh;
            border: 3px dashed var(--border-color);
            border-radius: 12px;
            margin: 40px;
            padding: 40px;
            transition: all 0.3s ease;
        }
        .drop-zone.dragover {
            border-color: var(--accent);
            background: rgba(86, 156, 214, 0.1);
        }
        .drop-zone h2 {
            color: var(--text-secondary);
            font-weight: normal;
            margin: 0 0 10px 0;
        }
        .loader-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.85);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        [data-theme="light"] .loader-overlay {
            background: rgba(255,255,255,0.9);
        }
        .loader-overlay.active {
            display: flex;
        }
        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--border-color);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .loader-text {
            margin-top: 20px;
            color: var(--text-primary);
            font-size: 14px;
        }
        .loader-progress {
            margin-top: 10px;
            color: var(--text-secondary);
            font-size: 12px;
        }
        /* Skeleton loading styles */
        .skeleton {
            background: linear-gradient(90deg, var(--bg-tertiary) 25%, var(--bg-secondary) 50%, var(--bg-tertiary) 75%);
            background-size: 200% 100%;
            animation: skeleton-pulse 1.5s ease-in-out infinite;
            border-radius: 4px;
        }
        @keyframes skeleton-pulse {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        .skeleton-text {
            height: 12px;
            margin: 8px 0;
        }
        .skeleton-box {
            height: 80px;
            margin: 10px 0;
        }
        .section-loading {
            padding: 15px;
            text-align: center;
            color: var(--text-muted);
            font-size: 11px;
        }
        .section-loading .mini-spinner {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid var(--border-color);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-right: 8px;
            vertical-align: middle;
        }
        .drop-zone p {
            color: var(--text-muted);
            margin: 5px 0;
        }
        .drop-zone .or {
            margin: 20px 0;
            color: var(--text-muted);
        }
        .drop-zone button {
            background: var(--accent);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .drop-zone button:hover {
            background: var(--accent-hover);
        }
        .hidden {
            display: none !important;
        }
        .main-content {
            padding: 5px 0;
            max-width: 100%;
            width: 100%;
        }
        .controls {
            display: flex;
            gap: 10px;
            margin-top: 8px;
            flex-wrap: wrap;
            align-items: center;
        }
        .kpis {
            margin-top: 8px;
        }
        .kpi {
            background: var(--bg-secondary);
            padding: 10px 15px;
            border-radius: 4px;
            border: 1px solid var(--border-color);
            position: relative;
        }
        .kpi.kpi-highlight-green {
            background: #e8f5e9;
            border-color: #81c784;
        }
        [data-theme="dark"] .kpi.kpi-highlight-green {
            background: #1b3a1b;
            border-color: #66bb6a;
        }
        .kpi.kpi-highlight-orange {
            background: #fff3e0;
            border-color: #ffb74d;
        }
        .kpi-expand-btn {
            background: none;
            border: 1px solid var(--border-color);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 14px;
            line-height: 18px;
            cursor: pointer;
            color: var(--text-muted);
            padding: 0;
            margin-left: 4px;
            vertical-align: middle;
        }
        .kpi-expand-btn:hover {
            background: var(--bg-secondary);
        }
        .kpi-collapsible {
            display: none;
        }
        .kpi-collapsible.expanded {
            display: block;
        }
        .disc-breakdown {
            display: flex;
            gap: 6px;
            margin-top: 4px;
            flex-wrap: wrap;
        }
        .disc-breakdown .disc-item {
            font-size: 9px;
            padding: 2px 6px;
            border-radius: 3px;
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            white-space: nowrap;
        }
        .disc-breakdown .disc-item .disc-val {
            font-weight: 600;
            color: var(--text-primary);
        }
        [data-theme="dark"] .kpi.kpi-highlight-orange {
            background: #3e2c1a;
            border-color: #e6862a;
        }
        .kpi-section {
            margin-top: 8px;
            border-top: 1px solid var(--border-color);
        }
        .kpi-section:first-child {
            margin-top: 0;
            border-top: none;
        }
        .kpi-section > summary {
            width: 100%;
            font-size: 11px;
            font-weight: bold;
            color: var(--text-secondary);
            text-transform: uppercase;
            padding: 8px 0 4px 0;
            letter-spacing: 0.5px;
            cursor: pointer;
            list-style: none;
        }
        .kpi-section > summary::-webkit-details-marker { display: none; }
        .kpi-section > summary::before {
            content: '▶';
            display: inline-block;
            margin-right: 6px;
            font-size: 8px;
            transition: transform 0.15s;
        }
        .kpi-section[open] > summary::before {
            transform: rotate(90deg);
        }
        .kpi-section-content {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 4px;
        }
        /* Parent sections that contain children: visual container */
        .kpi-section.has-children {
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 0 12px 12px 12px;
            margin-top: 10px;
            background: var(--bg-secondary);
        }
        .kpi-section.has-children > summary {
            padding: 10px 0 6px 0;
        }
        /* Nested (child) sections inside a parent container */
        .kpi-section-content > .kpi-section:not(.bg-gi):not(.bg-gu):not(.bg-pw) {
            margin-top: 8px;
            border-top: 1px solid var(--border-color);
            padding-top: 4px;
        }
        .kpi-section-content > .kpi-section:not(.bg-gi):not(.bg-gu):not(.bg-pw) > summary {
            font-size: 10px;
        }
        .kpi-section-content > table,
        .kpi-section-content > .kpi-sub-label,
        .kpi-section-content > div[style],
        .kpi-section-content > .kpi-row,
        .kpi-section-content > .kpi-section {
            width: 100%;
        }
        .kpi-sub-label {
            width: 100%;
            font-size: 10px;
            color: var(--text-secondary);
            padding: 6px 0 2px 0;
            opacity: 0.7;
        }
        .kpi-row {
            display: flex;
            gap: 10px;
            margin-top: 8px;
            margin-left: 14%;
        }
        .kpi-row > .kpi-section {
            flex: 1;
            margin-top: 0;
            border-top: none;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 6px 10px;
        }
        .kpi-row > .kpi-section:first-child {
            border-top: 1px solid var(--border-color);
        }
        .kpi-row > .kpi-section.bg-gi { background: rgba(59,130,246,0.06); border-color: rgba(59,130,246,0.25); }
        .kpi-row > .kpi-section.bg-gu { background: rgba(16,185,129,0.06); border-color: rgba(16,185,129,0.25); }
        .kpi-row > .kpi-section.bg-pw { background: rgba(245,158,11,0.06); border-color: rgba(245,158,11,0.25); }
        [data-theme="dark"] .kpi-row > .kpi-section.bg-gi { background: rgba(59,130,246,0.10); border-color: rgba(59,130,246,0.30); }
        [data-theme="dark"] .kpi-row > .kpi-section.bg-gu { background: rgba(16,185,129,0.10); border-color: rgba(16,185,129,0.30); }
        [data-theme="dark"] .kpi-row > .kpi-section.bg-pw { background: rgba(245,158,11,0.10); border-color: rgba(245,158,11,0.30); }
        .kpi-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
            margin: 8px 0;
        }
        .kpi-table.fixed-cols {
            table-layout: fixed;
        }
        .kpi-table tr:hover .bg-gi { background: rgba(59,130,246,0.12); }
        .kpi-table tr:hover .bg-gu { background: rgba(16,185,129,0.12); }
        .kpi-table tr:hover .bg-pw { background: rgba(245,158,11,0.12); }
        .kpi-table th, .kpi-table td {
            padding: 6px 10px;
            text-align: right;
            border-bottom: 1px solid var(--border-color);
        }
        .kpi-table th {
            font-size: 10px;
            font-weight: normal;
            color: var(--text-secondary);
            text-transform: uppercase;
            background: var(--bg-secondary);
        }
        .kpi-table th:first-child, .kpi-table td:first-child {
            text-align: left;
        }
        .kpi-table td:first-child {
            font-weight: 500;
            color: var(--text-primary);
        }
        .kpi-table td {
            color: var(--snp-consensus);
        }
        .kpi-table tr:hover {
            background: var(--bg-secondary);
        }
        .kpi-table .pct {
            font-size: 10px;
            color: var(--text-secondary);
            margin-left: 4px;
        }
        .kpi-table .info-icon {
            cursor: pointer;
            opacity: 0.5;
            font-size: 11px;
            margin-left: 3px;
        }
        .kpi-table .info-icon:hover {
            opacity: 1;
        }
        .bg-gi, .kpi-table .bg-gi { background: rgba(59,130,246,0.06); }
        .bg-gu, .kpi-table .bg-gu { background: rgba(16,185,129,0.06); }
        .bg-pw, .kpi-table .bg-pw { background: rgba(245,158,11,0.06); }
        [data-theme="dark"] .bg-gi, [data-theme="dark"] .kpi-table .bg-gi { background: rgba(59,130,246,0.10); }
        [data-theme="dark"] .bg-gu, [data-theme="dark"] .kpi-table .bg-gu { background: rgba(16,185,129,0.10); }
        [data-theme="dark"] .bg-pw, [data-theme="dark"] .kpi-table .bg-pw { background: rgba(245,158,11,0.10); }
        .kpi.kpi-gt {
            border-color: #7cb342;
        }
        .kpi .label {
            font-size: 11px;
            color: var(--text-secondary);
            text-transform: uppercase;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .kpi .info-icon {
            cursor: pointer;
            opacity: 0.5;
            font-size: 12px;
            transition: opacity 0.2s;
        }
        .kpi .info-icon:hover {
            opacity: 1;
        }
        .kpi .value {
            font-size: 18px;
            color: var(--snp-consensus);
            font-weight: bold;
        }
        /* Info Modal */
        .info-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }
        .info-modal.active {
            display: flex;
        }
        .info-modal-content {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }
        .info-modal-content h3 {
            margin: 0 0 15px 0;
            color: var(--accent);
            font-size: 16px;
        }
        .info-modal-content p {
            margin: 0 0 10px 0;
            color: var(--text-primary);
            font-size: 13px;
            line-height: 1.5;
        }
        .info-modal-content .formula {
            background: var(--bg-tertiary);
            padding: 8px 12px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            margin: 10px 0;
        }
        /* Strategy diagram grid */
        .strategy-diagram {
            display: inline-grid;
            gap: 0;
            font-family: monospace;
            font-size: 11px;
            margin: 10px 0;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            overflow: hidden;
        }
        .strategy-diagram .sd-cell {
            padding: 3px 8px;
            text-align: center;
            border-right: 1px solid var(--border-color);
            border-bottom: 1px solid var(--border-color);
        }
        .strategy-diagram .sd-cell:last-child { border-right: none; }
        .strategy-diagram .sd-header {
            background: var(--bg-tertiary);
            font-weight: bold;
            font-size: 10px;
            color: var(--text-secondary);
        }
        .strategy-diagram .sd-label {
            background: var(--bg-tertiary);
            font-weight: 600;
            text-align: left;
            font-size: 10px;
        }
        .strategy-diagram .sd-base { background: rgba(129,199,132,0.15); color: #4caf50; }
        .strategy-diagram .sd-snp { background: rgba(129,199,132,0.15); color: #4caf50; font-weight: bold; }
        .strategy-diagram .sd-gap { background: rgba(158,158,158,0.15); color: #9e9e9e; }
        .strategy-diagram .sd-excluded {
            background: repeating-linear-gradient(45deg, transparent, transparent 3px, rgba(244,67,54,0.08) 3px, rgba(244,67,54,0.08) 6px);
            color: var(--text-muted);
            text-decoration: line-through;
        }
        .strategy-diagram .sd-excluded.sd-gap {
            background: repeating-linear-gradient(45deg, rgba(158,158,158,0.10), rgba(158,158,158,0.10) 3px, rgba(244,67,54,0.12) 3px, rgba(244,67,54,0.12) 6px);
        }
        .strategy-diagram .sd-legend {
            font-size: 10px;
            padding: 4px 8px;
            color: var(--text-secondary);
            grid-column: 1 / -1;
            text-align: left;
            border-bottom: none;
        }
        .info-modal-close {
            position: absolute;
            top: 10px;
            right: 15px;
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 20px;
            cursor: pointer;
        }
        .info-modal-close:hover {
            color: var(--text-primary);
        }
        /* Detail modal (wider variant for position tables) */
        .detail-modal-content {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            max-width: 92vw;
            max-height: 85vh;
            overflow-y: auto;
            position: relative;
        }
        .detail-modal-content h3 {
            margin: 0 0 12px 0;
            color: var(--accent);
            font-size: 15px;
        }
        .detail-modal-content table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }
        .detail-modal-content th,
        .detail-modal-content td {
            padding: 3px 6px;
            border: 1px solid var(--border-color);
            text-align: center;
            white-space: nowrap;
        }
        .detail-modal-content th {
            background: var(--bg-tertiary);
            position: sticky;
            top: 0;
            z-index: 1;
        }
        .detail-modal-content .status-concordant { color: #4caf50; font-weight: bold; }
        .detail-modal-content .status-discordant { color: #f44336; font-weight: bold; }
        .detail-modal-content .status-lost { color: #9e9e9e; }
        .detail-modal-content .status-in_gt_gap { color: #ff9800; }
        .detail-modal-content .status-in_pl_gap { color: #ff9800; }
        .detail-modal-content .status-not_disc_in_pl { color: #78909c; }
        .detail-modal-content .status-pl_only { color: #7e57c2; }
        .detail-modal-content .allele-mismatch { color: #f44336; font-weight: bold; }
        .detail-modal-content .allele-gap { color: #9e9e9e; }
        .drill-btn {
            background: none;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            padding: 1px 5px;
            line-height: 1;
            color: var(--text-secondary);
        }
        .drill-btn:hover { background: var(--bg-tertiary); color: var(--text-primary); }
        .detail-modal-content .filter-bar {
            margin-bottom: 10px;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        .detail-modal-content .filter-btn {
            padding: 3px 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 12px;
        }
        .detail-modal-content .filter-btn.active {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }
        .detail-loading {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }
        /* Scroll to top button */
        .scroll-top-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 45px;
            height: 45px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            display: none;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            z-index: 1000;
            transition: opacity 0.3s, transform 0.3s;
        }
        .scroll-top-btn:hover {
            transform: scale(1.1);
            background: var(--accent-hover);
        }
        .scroll-top-btn.visible {
            display: flex;
        }
        /* Per-sample statistics table */
        .stats-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 11px;
            margin-top: 10px;
        }
        .stats-table th, .stats-table td {
            padding: 6px 10px;
            border: 1px solid var(--border-color);
            text-align: right;
        }
        .stats-table th {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            font-weight: bold;
            text-align: center;
        }
        .stats-table th:first-child, .stats-table td:first-child {
            text-align: left;
            font-weight: bold;
            color: var(--label-color);
        }
        .stats-table tr:hover {
            background: var(--bg-tertiary);
        }
        .stats-table .pipeline-header {
            background: var(--bg-secondary);
            color: var(--accent);
        }
        .stats-table .good { color: #81c784; }
        .stats-table .warning { color: #ffd54f; }
        .stats-table .bad { color: #e57373; }
        .stats-table .info-icon {
            cursor: pointer;
            opacity: 0.5;
            font-size: 11px;
            margin-left: 3px;
        }
        .stats-table .info-icon:hover {
            opacity: 1;
        }
        .collapsible-panel {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 8px 12px;
            margin: 0 4px 10px 4px;
            font-size: 11px;
        }
        .collapsible-panel summary {
            cursor: pointer;
            color: var(--accent);
            user-select: none;
            font-weight: bold;
            padding: 4px 0;
        }
        .collapsible-panel summary:hover {
            color: var(--text-primary);
        }
        .collapsible-panel summary::marker {
            color: var(--text-secondary);
        }
        .collapsible-panel.nested {
            background: var(--bg-primary);
            margin: 0 0 10px 0;
            padding: 6px 10px;
        }
        .collapsible-panel.nested summary {
            font-size: 12px;
            color: var(--label-color);
        }
        .footer {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            margin-top: 15px;
            border-top: 1px solid var(--border-color);
            font-size: 10px;
            color: var(--text-secondary);
        }
        .warnings-container {
            margin-top: 10px;
        }
        .warning-item {
            background: rgba(220, 180, 50, 0.15);
            border: 1px solid #dcb432;
            border-radius: 4px;
            padding: 8px 12px;
            margin-bottom: 6px;
            color: #dcb432;
            font-size: 11px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .warning-item::before {
            content: "⚠";
            font-size: 14px;
        }
        .mnp-warning {
            cursor: pointer;
            margin-left: 4px;
            font-size: 12px;
        }
        .description-content {
            font-size: 12px;
            line-height: 1.6;
            color: var(--text-primary);
        }
        .description-content h1 { font-size: 18px; margin: 0 0 12px 0; color: var(--accent); }
        .description-content h2 { font-size: 15px; margin: 16px 0 8px 0; color: var(--accent); }
        .description-content h3 { font-size: 13px; margin: 12px 0 6px 0; color: var(--text-primary); }
        .description-content p { margin: 8px 0; }
        .description-content ul, .description-content ol { margin: 8px 0; padding-left: 24px; }
        .description-content li { margin: 4px 0; }
        .description-content code { background: var(--bg-tertiary); padding: 2px 6px; border-radius: 3px; font-size: 11px; }
        .description-content pre { background: var(--bg-tertiary); padding: 12px; border-radius: 4px; overflow-x: auto; }
        .description-content pre code { background: none; padding: 0; }
        .description-content strong { color: var(--text-primary); }
        .description-content em { font-style: italic; }
        .description-content a { color: var(--accent); }
        .description-content .md-table { width: 100%; border-collapse: collapse; margin: 12px 0; font-size: 12px; }
        .description-content .md-table th,
        .description-content .md-table td { padding: 8px 12px; border: 1px solid var(--border-color); text-align: left; }
        .description-content .md-table th { background: var(--bg-tertiary); font-weight: bold; }
        .description-content .md-table tr:nth-child(even) { background: var(--bg-secondary); }
        .pipeline-info-item {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 10px 12px;
            margin-bottom: 8px;
        }
        .pipeline-info-item .pipeline-name {
            font-weight: bold;
            color: var(--text-primary);
            margin-bottom: 4px;
        }
        .pipeline-info-item .pipeline-command {
            font-family: monospace;
            font-size: 11px;
            color: var(--text-secondary);
            background: var(--bg-primary);
            padding: 6px 8px;
            border-radius: 3px;
            overflow-x: auto;
            white-space: pre-wrap;
            word-break: break-all;
        }
        .pipeline-info-item .pipeline-badge {
            display: inline-block;
            font-size: 9px;
            padding: 2px 6px;
            border-radius: 3px;
            margin-left: 8px;
            background: var(--accent-color);
            color: white;
        }
        .repro-section {
            margin-bottom: 15px;
        }
        .repro-section h4 {
            margin: 0 0 8px 0;
            color: var(--text-primary);
            font-size: 12px;
        }
        .repro-cmd {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            margin-bottom: 6px;
        }
        .repro-cmd code {
            flex: 1;
            font-family: monospace;
            font-size: 10px;
            background: var(--bg-primary);
            padding: 6px 8px;
            border-radius: 3px;
            overflow-x: auto;
            white-space: pre;
            color: var(--text-secondary);
        }
        .repro-cmd button {
            padding: 4px 8px;
            font-size: 10px;
            background: var(--accent-color);
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        .repro-cmd button:hover {
            opacity: 0.8;
        }
        .repro-note {
            font-size: 10px;
            color: var(--text-secondary);
            margin-top: 4px;
            font-style: italic;
        }
        #file-input {
            display: none;
        }
        .distance-matrix-table {
            margin-top: 10px;
            font-size: 10px;
            border-collapse: collapse;
            width: 100%;
        }
        .table-wrapper {
            overflow-x: auto;
            width: 100%;
        }
        .distance-matrix-table th,
        .distance-matrix-table td {
            padding: 4px 8px;
            text-align: center;
            border: 1px solid var(--border-color);
            white-space: nowrap;
        }
        .distance-matrix-table th {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            font-weight: bold;
        }
        .distance-matrix-table td.diagonal {
            background: var(--bg-tertiary);
            color: var(--text-muted);
        }
        .distance-matrix-table td.low-dist {
            background: rgba(78, 201, 176, 0.2);
            color: var(--snp-consensus);
        }
        .distance-matrix-table td.medium-dist {
            background: rgba(220, 220, 170, 0.2);
            color: var(--snp-uncertain);
        }
        .distance-matrix-table td.high-dist {
            background: rgba(244, 71, 71, 0.2);
            color: var(--snp-discord);
        }
        .distance-matrix-table td .comparable {
            font-size: 8px;
            color: var(--text-muted);
            display: block;
        }
    </style>
</head>
<body>
    <div class="loader-overlay" id="loader">
        <div class="spinner"></div>
        <div class="loader-text" id="loader-text">Loading...</div>
        <div class="loader-progress" id="loader-progress"></div>
    </div>

    <!-- Scroll to top button -->
    <button class="scroll-top-btn" id="scroll-top-btn" onclick="scrollToTop()" title="Scroll to top">↑</button>

    <!-- Info Modal -->
    <div class="info-modal" id="info-modal" onclick="if(event.target===this)closeInfoModal()">
        <div class="info-modal-content">
            <button class="info-modal-close" onclick="closeInfoModal()">&times;</button>
            <h3 id="info-modal-title">KPI Info</h3>
            <div id="info-modal-body"></div>
        </div>
    </div>

    <!-- Detail modal for GT Disc position-level data -->
    <div class="info-modal" id="detail-modal" onclick="if(event.target===this)closeDetailModal()">
        <div class="detail-modal-content">
            <button class="info-modal-close" onclick="closeDetailModal()">&times;</button>
            <h3 id="detail-modal-title">Position Details</h3>
            <div id="detail-modal-body"></div>
        </div>
    </div>

    <div class="header">
        <h1 onclick="goToLanding()" style="cursor:pointer;" title="Back to home">CoreGuard SNP Comparison Viewer</h1>
        <div class="header-right">
            <div class="info" id="header-info">Drop a report to begin (.json, .json.gz, .bin, .bin.gz)</div>
            <button class="theme-toggle" id="theme-toggle" onclick="toggleTheme()" title="Toggle light/dark mode"></button>
        </div>
    </div>

    <div id="drop-zone" class="drop-zone">
        <div style="max-width: 700px; text-align: left;">
            <h2 style="text-align: center; margin-bottom: 1.5rem;">SNP Pipeline Comparison Viewer</h2>

            <div style="display: flex; flex-direction: column; gap: 1rem; margin-bottom: 1.5rem;">
                <div style="background: var(--bg-tertiary); padding: 1rem; border-radius: 8px; border-left: 3px solid var(--accent);">
                    <div style="color: var(--accent); font-weight: bold; margin-bottom: 0.5rem;">1. Generate a report</div>
                    <p style="font-size: 12px; margin: 0 0 0.5rem 0; color: var(--text-secondary);">Create a YAML config with your VCF/BAM files, then run:</p>
                    <code style="display: block; background: var(--bg-primary); padding: 8px 12px; border-radius: 4px; font-size: 11px; overflow-x: auto;">coreguard compare --config project.yaml -o report.bin.gz --binary --gzip</code>
                </div>
                <div style="background: var(--bg-tertiary); padding: 1rem; border-radius: 8px; border-left: 3px solid var(--accent);">
                    <div style="color: var(--accent); font-weight: bold; margin-bottom: 0.5rem;">2. Upload and visualize</div>
                    <p style="font-size: 12px; margin: 0 0 0.5rem 0; color: var(--text-secondary);">Drop your report file here or click to browse:</p>
                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                        <button onclick="document.getElementById('file-input').click()" style="flex: 1;">Choose File</button>
                        <span style="font-size: 11px; color: var(--text-muted);">.json .json.gz .bin .bin.gz</span>
                    </div>
                </div>
            </div>

            <input type="file" id="file-input" accept=".json,.json.gz,.bin,.bin.gz,.gz" style="display: none;" />

            <div style="padding-top: 1rem; border-top: 1px solid var(--border-color);">
                <div style="text-align: center; margin-bottom: 1rem;">
                    <p style="font-size: 12px; color: var(--text-secondary); margin: 0 0 0.75rem 0;">Or try a demo dataset:</p>
                    <div style="display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
                        <div style="text-align: center;">
                            <button onclick="loadDemo()" style="background: #455a64; font-size: 13px; padding: 10px 16px;">Demo 1</button>
                            <p style="font-size: 9px; opacity: 0.7; margin-top: 4px;">4 <i>L. mono</i></p>
                        </div>
                        <div style="text-align: center;">
                            <button onclick="loadDemo2()" style="background: #5d4037; font-size: 13px; padding: 10px 16px;">Demo 2</button>
                            <p style="font-size: 9px; opacity: 0.7; margin-top: 4px;">53 <i>L. mono</i></p>
                        </div>
                        <div style="text-align: center;">
                            <button onclick="loadDemo3()" style="background: #2e7d32; font-size: 13px; padding: 10px 16px;">Demo 3</button>
                            <p style="font-size: 9px; opacity: 0.7; margin-top: 4px;">17 <i>B. melitensis</i></p>
                        </div>
                        <div style="text-align: center;">
                            <button onclick="loadDemo4()" style="background: #7b1fa2; font-size: 13px; padding: 10px 16px;">Demo 4</button>
                            <p style="font-size: 9px; opacity: 0.7; margin-top: 4px;">10 WNV</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div style="margin-top: 1.5rem; opacity: 0.6;">
            <a href="https://github.com/genpat-it/coreguard" target="_blank" style="color: inherit; text-decoration: none;" title="View on GitHub">
                <svg height="20" width="20" viewBox="0 0 16 16" fill="currentColor" style="vertical-align: middle;">
                    <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/>
                </svg>
                GitHub
            </a>
        </div>
    </div>

    <div id="viewer" class="main-content hidden">
        <details class="collapsible-panel" id="description-panel" style="display:none;">
            <summary>Description</summary>
            <div id="description-view" class="description-content"></div>
        </details>

        <details class="collapsible-panel" id="config-panel" style="display:none;">
            <summary>Configuration</summary>
            <div id="config-view" style="padding:10px;"><pre id="config-yaml" style="background:var(--bg-secondary);color:var(--text-primary);padding:12px;border-radius:6px;font-size:11px;line-height:1.5;overflow-x:auto;white-space:pre-wrap;margin:0;"></pre></div>
        </details>

        <details class="collapsible-panel" id="pipelines-panel">
            <summary>Pipelines</summary>
            <div id="pipelines-info">
                <p style="color:var(--text-secondary);font-size:11px;">Pipeline information will be shown here after loading data.</p>
            </div>
        </details>

        <details class="collapsible-panel" open>
            <summary>Statistics</summary>
            <div class="kpis" id="kpis"></div>
            <div class="warnings-container" id="warnings"></div>
        </details>

        <details class="collapsible-panel" id="distance-matrix-panel" open>
            <summary>SNP Distance Matrices</summary>
            <div class="distance-matrix-content" id="distance-matrix-content">
                <div id="matrix-result"></div>
            </div>
        </details>

        <div class="footer" id="footer">
            <span onclick="goToLanding()" style="cursor: pointer;" title="Back to home">CoreGuard SNP Comparison Viewer</span>
            <span id="report-timestamp"></span>
            <a href="https://github.com/genpat-it/coreguard" target="_blank" style="color: inherit; text-decoration: none; margin-left: 1rem;" title="View on GitHub">
                <svg height="16" width="16" viewBox="0 0 16 16" fill="currentColor" style="vertical-align: middle;">
                    <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/>
                </svg>
                GitHub
            </a>
        </div>
    </div>

    <!-- Pako for gzip decompression -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>

    <script>
        // Theme toggling (non-module, runs immediately)
        function initTheme() {
            const savedTheme = localStorage.getItem('coreguard-theme') || 'dark';
            document.documentElement.setAttribute('data-theme', savedTheme === 'light' ? 'light' : '');
            updateThemeIcon(savedTheme);
        }

        function toggleTheme() {
            const currentTheme = localStorage.getItem('coreguard-theme') || 'dark';
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            localStorage.setItem('coreguard-theme', newTheme);
            document.documentElement.setAttribute('data-theme', newTheme === 'light' ? 'light' : '');
            updateThemeIcon(newTheme);
        }

        function updateThemeIcon(theme) {
            const btn = document.getElementById('theme-toggle');
            if (btn) {
                btn.classList.toggle('light', theme === 'light');
                btn.title = theme === 'dark' ? 'Switch to light mode' : 'Switch to dark mode';
            }
        }

        // Initialize theme on page load
        initTheme();

        // KPI Info Modal
        const kpiDescriptions = {
            'reference': {
                title: 'Reference Genome',
                body: `<p>The length of the reference genome in base pairs (bp).</p>
                       <p>All samples are aligned against this reference sequence for SNP calling.</p>`
            },
            'samples': {
                title: 'Number of Samples',
                body: `<p>Total number of samples (isolates) included in this comparison.</p>`
            },
            'pipelines': {
                title: 'Number of Pipelines',
                body: `<p>Number of different SNP calling pipelines being compared.</p>
                       <p>Each pipeline may use different algorithms, parameters, or reference-based variant calling approaches.</p>`
            },
            'snps': {
                title: 'SNP Count',
                body: `<p>Total number of Single Nucleotide Polymorphisms (SNPs) detected by this pipeline across all samples.</p>
                       <div class="formula">% = (SNPs / Reference Length / Samples) × 100</div>
                       <p>The percentage indicates the average SNP density per sample relative to the reference genome.</p>`
            },
            'gaps': {
                title: 'Gap Regions',
                body: `<p>Total base pairs with insufficient coverage (depth < minimum threshold) across all samples.</p>
                       <div class="formula">% = (Gap bp / Reference Length / Samples) × 100</div>
                       <p>Gaps indicate regions where the pipeline could not confidently call variants due to low read coverage.</p>
                       <p><strong>High gap percentage</strong> may indicate poor sequencing quality or divergent samples.</p>`
            },
            'snps_in_gt_gaps': {
                title: 'Any SNPs in Ref Gaps',
                body: `<p>SNP positions in Ref gap regions where <strong>at least 1 sample</strong> has a SNP.</p>
                       <div class="formula">% = (Any SNPs in Ref Gaps / Any SNPs) × 100</div>
                       <p><strong>Any</strong> = position has SNP in ≥1 sample</p>
                       <p><strong>Interpretation:</strong></p>
                       <ul style="margin:5px 0;padding-left:20px;font-size:12px;">
                           <li><span style="color:#81c784;">Green (&lt;1%)</span>: Good - few SNPs in unreliable regions</li>
                           <li><span style="color:#e57373;">Red (&gt;1%)</span>: Potential false positives in low-coverage regions</li>
                       </ul>`
            },
            'all_snps_in_gt_gaps': {
                title: 'All SNPs in Ref Gaps',
                body: `<p>SNP positions in Ref gap regions where <strong>ALL samples</strong> have a SNP.</p>
                       <div class="formula">% = (All SNPs in Ref Gaps / All SNPs) × 100</div>
                       <p><strong>All</strong> = position has SNP in ALL samples (position-based, any allele)</p>
                       <p><strong>Interpretation:</strong></p>
                       <ul style="margin:5px 0;padding-left:20px;font-size:12px;">
                           <li>These are consistently called SNPs in unreliable regions</li>
                           <li>May indicate systematic differences between pipelines</li>
                       </ul>`
            },
            'consensus_snps_in_gt_gaps': {
                title: 'Consensus SNPs in Ref Gaps',
                body: `<p>SNP positions in Ref gap regions where <strong>ALL samples have the SAME allele</strong>.</p>
                       <div class="formula">% = (Consensus SNPs in Ref Gaps / Consensus SNPs) × 100</div>
                       <p><strong>Consensus</strong> = ALL samples have identical alt allele</p>
                       <p><strong>Interpretation:</strong></p>
                       <ul style="margin:5px 0;padding-left:20px;font-size:12px;">
                           <li>Most reliable variant calls in unreliable regions</li>
                           <li>Consensus SNPs in Ref gaps warrant closer inspection</li>
                       </ul>`
            },
            'snps_in_pipeline_gaps': {
                title: 'SNPs in Pipeline Gaps',
                body: `<p>SNPs from one pipeline that fall within gap regions of another pipeline.</p>
                       <div class="formula">% = (SNPs in Gaps / Total SNPs) × 100</div>
                       <p><strong>Interpretation:</strong></p>
                       <ul style="margin:5px 0;padding-left:20px;font-size:12px;">
                           <li>Shows SNPs called by one pipeline in regions where another has low coverage</li>
                           <li>High values may indicate false positives or differences in coverage</li>
                           <li>Useful for comparing pipeline reliability across different regions</li>
                       </ul>`
            },
            // Per-Sample Statistics metrics
            'ps_snps': {
                title: 'Per-Sample SNPs',
                body: `<p>Number of SNPs called by this pipeline for this sample.</p>
                       <div class="formula">% = (SNPs / Reference Length) × 100</div>
                       <p>Percentage shows SNP density relative to the reference genome size.</p>`
            },
            'ps_gaps': {
                title: 'Per-Sample Gaps',
                body: `<p>Total base pairs with insufficient coverage (depth < minimum threshold) for this sample.</p>
                       <div class="formula">% = (Gap bp / Reference Length) × 100</div>
                       <p>Gaps indicate regions where the pipeline could not confidently call variants.</p>`
            },
            'ps_vs_gt': {
                title: 'vs Ref (Agreement)',
                body: `<p>Pipeline SNPs that are at the same positions as Ref SNPs for this sample.</p>
                       <div class="formula">% = (Pipeline ∩ Ref SNP positions / Pipeline SNPs) × 100</div>
                       <p><strong>Interpretation:</strong></p>
                       <ul style="margin:5px 0;padding-left:20px;font-size:12px;">
                           <li><span style="color:#81c784;">≥90%</span>: Good agreement with reference</li>
                           <li><span style="color:#ffc107;">70-90%</span>: Moderate agreement</li>
                           <li><span style="color:#e57373;">&lt;70%</span>: Poor agreement</li>
                       </ul>`
            },
            'ps_in_gt_gaps': {
                title: 'in Ref Gaps',
                body: `<p>Pipeline SNPs that fall within Ref gap regions (low coverage in Ref).</p>
                       <div class="formula">% = (SNPs in Ref Gaps / Pipeline SNPs) × 100</div>
                       <p><strong>Interpretation:</strong></p>
                       <ul style="margin:5px 0;padding-left:20px;font-size:12px;">
                           <li><span style="color:#81c784;">≤1%</span>: Good - few SNPs in unreliable Ref regions</li>
                           <li><span style="color:#ffc107;">1-5%</span>: Some SNPs in Ref gaps</li>
                           <li><span style="color:#e57373;">&gt;5%</span>: Many SNPs in Ref gaps - potential false positives</li>
                       </ul>`
            },
            'ps_intersection': {
                title: 'Pipeline ∩ Ref Intersection',
                body: `<p>SNP positions where both the pipeline and Ref have called a SNP for this sample.</p>
                       <div class="formula">Intersection = |Pipeline SNP positions ∩ Ref SNP positions|</div>
                       <div class="formula">% = (Intersection / Ref SNPs) × 100</div>
                       <p>Shows what percentage of Ref SNPs are also called by the pipeline.</p>`
            },
            'ps_vcf_consensus': {
                title: 'VCF Consensus SNPs',
                body: `<p>SNP positions where ALL VCF pipelines (excluding Ref) agree for this sample.</p>
                       <div class="formula">VCF Consensus = ∩ all VCF pipelines</div>
                       <div class="formula">% = (VCF Consensus / Reference Length) × 100</div>
                       <p>These are the most confident variant calls where all VCF-based pipelines agree.</p>`
            },
            'ps_consensus_in_gt': {
                title: 'VCF Consensus in Ref',
                body: `<p>VCF consensus SNPs that are also present in Ref for this sample.</p>
                       <div class="formula">% = (VCF Consensus ∩ Ref / VCF Consensus) × 100</div>
                       <p>High percentage means VCF consensus aligns well with reference.</p>`
            },
            'ps_all_consensus': {
                title: 'All Consensus (Ref ∩ VCF)',
                body: `<p>Positions where ALL pipelines (including Ref) agree for this sample.</p>
                       <div class="formula">All Consensus = Ref ∩ VCF Consensus</div>
                       <div class="formula">% = (All Consensus / Reference Length) × 100</div>
                       <p>These are the highest confidence calls - all pipelines agree.</p>`
            },
            'gt_snps_missing': {
                title: 'Any Ref SNPs Filtered',
                body: `<p>Ref SNP positions (≥1 sample) that this pipeline does <strong>NOT</strong> call.</p>
                       <div class="formula">Σ(Ref<sub>sample</sub> - (Ref<sub>sample</sub> ∩ Pipeline<sub>sample</sub>))</div>
                       <p><strong>Any</strong> = position has SNP in ≥1 sample</p>
                       <p><strong>Interpretation:</strong></p>
                       <ul style="margin:5px 0;padding-left:20px;font-size:12px;">
                           <li>Shows Ref SNPs being "filtered out" by each pipeline</li>
                           <li>Higher values = more aggressive filtering</li>
                       </ul>`
            },
            'all_gt_missing': {
                title: 'All Ref SNPs Filtered',
                body: `<p>Ref SNP positions (ALL samples) not present in the pipeline.</p>
                       <div class="formula">|All Ref| - |All Ref ∩ All Pipeline|</div>
                       <p><strong>All</strong> = position has SNP in ALL samples (position-based)</p>
                       <p><strong>Interpretation:</strong></p>
                       <ul style="margin:5px 0;padding-left:20px;font-size:12px;">
                           <li>Shows consistent Ref SNPs missing from pipeline</li>
                           <li>Lower = pipeline captures consistent Ref signal</li>
                       </ul>`
            },
            'consensus_gt_missing': {
                title: 'Consensus Ref SNPs Filtered',
                body: `<p>Ref Consensus positions not present in the pipeline's consensus.</p>
                       <div class="formula">|Consensus Ref| - |Consensus Ref ∩ Consensus Pipeline|</div>
                       <p><strong>Consensus</strong> = ALL samples have identical alt allele</p>
                       <p><strong>Interpretation:</strong></p>
                       <ul style="margin:5px 0;padding-left:20px;font-size:12px;">
                           <li>Shows highly reliable Ref SNPs missing from pipeline's consensus</li>
                           <li>Lower = pipeline captures consistent variant calls</li>
                       </ul>`
            },
            'bam_pileup': {
                title: 'BAM Pileup — SNP Calling Logic',
                body: `<p>⚠️ <strong>These SNPs were derived from BAM pileup analysis</strong>, not from a variant calling pipeline.</p>
                       <p><strong>How a position is classified:</strong></p>
                       <ol style="margin:5px 0;padding-left:20px;font-size:12px;">
                           <li>Count all reads at the position (A, C, G, T)</li>
                           <li>If total depth &lt; <code>min_depth</code> → <strong>Gap</strong> (position ignored)</li>
                           <li>Take the most frequent base (majority vote)</li>
                           <li>If majority base &lt; <code>min_consensus</code> (default 80%) of reads → <strong>Ambiguous</strong> (position ignored)</li>
                           <li>If majority base ≠ reference → <strong>SNP</strong></li>
                       </ol>
                       <table style="width:100%;font-size:11px;border-collapse:collapse;margin:8px 0;">
                       <tr style="background:var(--bg-tertiary);"><th style="padding:4px 6px;text-align:left;">Example</th><th style="padding:4px 6px;text-align:left;">Reads</th><th style="padding:4px 6px;text-align:left;">Result</th></tr>
                       <tr style="border-bottom:1px solid var(--border-color);">
                           <td style="padding:4px 6px;">Ref=T, 100 reads</td>
                           <td style="padding:4px 6px;font-family:monospace;">85×A, 15×T</td>
                           <td style="padding:4px 6px;">A is 85% → <strong>SNP (A)</strong></td>
                       </tr>
                       <tr style="border-bottom:1px solid var(--border-color);">
                           <td style="padding:4px 6px;">Ref=T, 100 reads</td>
                           <td style="padding:4px 6px;font-family:monospace;">75×A, 25×T</td>
                           <td style="padding:4px 6px;">A is 75% &lt; 80% → <strong>Ambiguous</strong> (skipped)</td>
                       </tr>
                       <tr>
                           <td style="padding:4px 6px;">Ref=T, 3 reads</td>
                           <td style="padding:4px 6px;font-family:monospace;">3×A</td>
                           <td style="padding:4px 6px;">Depth 3 &lt; min_depth → <strong>Gap</strong></td>
                       </tr>
                       </table>
                       <p style="font-size:11px;"><strong>Parameters (configurable in YAML):</strong></p>
                       <ul style="margin:5px 0;padding-left:20px;font-size:12px;">
                           <li><code>min_depth</code>: minimum read depth to consider a position (default from <code>options.min_depth</code>)</li>
                           <li><code>min_consensus</code>: minimum fraction of reads agreeing on a base (currently 80%)</li>
                       </ul>
                       <p><strong>Use case:</strong> Reference baseline for comparing pipeline filtering behavior.</p>`
            },
            'concordance': {
                title: 'Position Concordance',
                body: `<p><strong>Concordance</strong> = SNP positions called by BOTH pipelines (regardless of allele).</p>
                       <div class="formula">Concordance = positions where Pipeline A AND Pipeline B call a SNP</div>
                       <p><strong>Two modes:</strong></p>
                       <ul style="margin:5px 0;padding-left:20px;font-size:12px;">
                           <li><strong>Any:</strong> At least 1 sample has SNP in both pipelines at this position</li>
                           <li><strong>All:</strong> ALL samples have SNP in both pipelines (Core_A ∩ Core_B)</li>
                       </ul>
                       <p><strong>Note:</strong> Concordance only checks if a SNP exists - it does NOT compare the actual allele called.</p>`
            },
            'consensus': {
                title: 'Allele Consensus',
                body: `<p><strong>Consensus</strong> = SNP positions where BOTH pipelines call the SAME allele.</p>
                       <div class="formula">Consensus = positions where Pipeline A alt == Pipeline B alt</div>
                       <p><strong>Two modes:</strong></p>
                       <ul style="margin:5px 0;padding-left:20px;font-size:12px;">
                           <li><strong>Any:</strong> At least 1 sample has the same allele in both pipelines</li>
                           <li><strong>All:</strong> ALL samples have the same allele in both pipelines</li>
                       </ul>
                       <p><strong>Note:</strong> Consensus ≤ Concordance (consensus is a subset where alleles match).</p>
                       <p><strong>Interpretation:</strong></p>
                       <ul style="margin:5px 0;padding-left:20px;font-size:12px;">
                           <li>Consensus ≈ Concordance: pipelines agree on alleles</li>
                           <li>Consensus &lt;&lt; Concordance: pipelines find same positions but call different alleles</li>
                       </ul>`
            },
            'mnp': {
                title: 'MNP Decomposition',
                body: `<p><strong>MNP (Multi-Nucleotide Polymorphism)</strong> = multiple adjacent SNPs reported as a single variant in VCF.</p>
                       <p><strong>Example:</strong></p>
                       <div class="formula">VCF: pos=100, REF=ACG, ALT=TGA</div>
                       <p>This MNP is decomposed into 3 individual SNPs:</p>
                       <ul style="margin:5px 0;padding-left:20px;font-size:12px;">
                           <li>pos=100: A→T</li>
                           <li>pos=101: C→G</li>
                           <li>pos=102: G→A</li>
                       </ul>
                       <p><strong>Why decompose?</strong></p>
                       <ul style="margin:5px 0;padding-left:20px;font-size:12px;">
                           <li>Consistent position-level comparison between pipelines</li>
                           <li>Some pipelines report MNPs, others report individual SNPs</li>
                           <li>Enables accurate intersection and agreement calculations</li>
                       </ul>
                       <p><strong>Note:</strong> The total SNP count increases after decomposition, which is expected.</p>`
            },
            'mnps': {
                title: 'MNP Statistics',
                body: `<p><strong>MNPs Detected</strong> = Number of Multi-Nucleotide Polymorphisms found and decomposed into individual SNPs.</p>
                       <div class="formula">Format: X → Y SNPs</div>
                       <p>Where X = number of MNPs found, Y = total individual SNPs they produced.</p>
                       <p><strong>Example:</strong> "50 → 127 SNPs" means 50 MNPs were decomposed into 127 individual SNPs.</p>
                       <p><strong>Why track this?</strong></p>
                       <ul style="margin:5px 0;padding-left:20px;font-size:12px;">
                           <li>Shows pipeline-specific MNP handling</li>
                           <li>Higher MNP count may indicate different variant calling approach</li>
                           <li>Helps understand differences between pipelines</li>
                       </ul>`
            },
            'filtered': {
                title: 'Filtered Positions',
                body: `<p>Number of positions matching the currently active filters.</p>
                       <p>Use the filter buttons to narrow down positions by:</p>
                       <ul style="margin:5px 0;padding-left:20px;font-size:12px;">
                           <li><strong>Pipeline filters:</strong> Show only SNPs from specific pipelines</li>
                           <li><strong>Consensus:</strong> Show positions where selected pipelines agree</li>
                           <li><strong>Discordant:</strong> Show positions where pipelines disagree</li>
                           <li><strong>Gap filters:</strong> Show gap regions for specific pipelines</li>
                       </ul>`
            },
            'filter_pipeline': {
                title: 'Pipeline SNP Filter',
                body: `<p>Show only positions where this pipeline called a SNP.</p>
                       <p><strong>Multiple pipelines selected:</strong></p>
                       <ul style="margin:5px 0;padding-left:20px;font-size:12px;">
                           <li><strong>OR mode:</strong> Position has SNP in ANY selected pipeline</li>
                           <li><strong>AND mode:</strong> Position has SNP in ALL selected pipelines</li>
                       </ul>
                       <p>Use the mode selector to switch between OR/AND logic.</p>`
            },
            'filter_consensus': {
                title: 'Consensus Filter',
                body: `<p>Show positions where <strong>ALL selected pipelines agree</strong> on having a SNP.</p>
                       <p>If no pipeline filters are selected, uses all VCF pipelines.</p>
                       <p><strong>Example:</strong> With CFSAN and Snippy selected, shows positions where both call a SNP at the same position.</p>
                       <p><strong>Note:</strong> This is the intersection of selected pipelines' SNP positions.</p>`
            },
            'filter_discordant': {
                title: 'Discordant Filter',
                body: `<p>Show positions where <strong>pipelines disagree</strong> - at least one has a SNP and at least one doesn't.</p>
                       <p>If no pipeline filters are selected, uses all VCF pipelines.</p>
                       <p><strong>Use case:</strong> Find positions where variant callers give different results, useful for:</p>
                       <ul style="margin:5px 0;padding-left:20px;font-size:12px;">
                           <li>Identifying pipeline-specific artifacts</li>
                           <li>Finding borderline/low-confidence variants</li>
                           <li>Quality control and validation</li>
                       </ul>`
            },
            'filter_gaps': {
                title: 'Gap Filter',
                body: `<p>Show positions where this pipeline has a <strong>coverage gap</strong> (depth below threshold).</p>
                       <p>Gaps indicate regions where:</p>
                       <ul style="margin:5px 0;padding-left:20px;font-size:12px;">
                           <li>Read coverage was insufficient for variant calling</li>
                           <li>The sample may be missing this genomic region</li>
                           <li>Sequencing quality was poor in this area</li>
                       </ul>
                       <p><strong>Note:</strong> SNPs called in gap regions of other pipelines may be less reliable.</p>`
            },
            'core_snps': {
                title: 'All SNPs (position-based)',
                body: `<p><strong>All</strong> = SNP positions present in <strong>ALL samples</strong> within this pipeline.</p>
                       <p>Position-based: counts where ALL samples have a SNP, regardless of which allele.</p>
                       <p><strong>Use:</strong></p>
                       <ul style="margin:5px 0;padding-left:20px;font-size:12px;">
                           <li>High % = consistent variant calling across samples</li>
                           <li>Low % = many sample-specific variants</li>
                       </ul>
                       <p><strong>Note:</strong> "All" ⊇ "Consensus" (All includes Consensus as a subset)</p>`
            },
            'consensus_snps': {
                title: 'Consensus SNPs',
                body: `<p><strong>Consensus SNPs</strong> = SNP positions where <strong>ALL samples within this pipeline</strong> have the <strong>SAME alt allele</strong>.</p>
                       <p>This is the intersection of SNP positions across all variant callers.</p>
                       <p><strong>Use:</strong></p>
                       <ul style="margin:5px 0;padding-left:20px;font-size:12px;">
                           <li>High consensus % = pipelines mostly agree</li>
                           <li>Low consensus % = pipelines find different variants (method-specific calls)</li>
                       </ul>
                       <p><strong>Note:</strong> The consensus count is the same for all pipelines since it's the intersection.</p>`
            },
            'pp_gi_usable': {
                title: 'Gap-Intersect — Usable Space',
                body: `<p>Reference positions remaining after removing only those where <strong>ALL samples</strong> have a gap in this pipeline.</p>
                       <div class="formula">Usable Space = Reference Length − intersection(pipeline gaps of all samples)</div>
                       <p>More permissive: a position is excluded only if every sample has a gap there.</p>
                       <div class="strategy-diagram" style="grid-template-columns: auto repeat(7, 1fr);">
                         <div class="sd-cell sd-header"></div><div class="sd-cell sd-header">Pos 1</div><div class="sd-cell sd-header">Pos 2</div><div class="sd-cell sd-header">Pos 3</div><div class="sd-cell sd-header">Pos 4</div><div class="sd-cell sd-header">Pos 5</div><div class="sd-cell sd-header">Pos 6</div><div class="sd-cell sd-header">Pos 7</div>
                         <div class="sd-cell sd-label">Ref</div><div class="sd-cell">T</div><div class="sd-cell">A</div><div class="sd-cell">G</div><div class="sd-cell">C</div><div class="sd-cell">A</div><div class="sd-cell">T</div><div class="sd-cell">G</div>
                         <div class="sd-cell sd-label">S1</div><div class="sd-cell sd-snp">A</div><div class="sd-cell sd-gap">—</div><div class="sd-cell sd-base">G</div><div class="sd-cell sd-snp">T</div><div class="sd-cell sd-gap sd-excluded">—</div><div class="sd-cell sd-base">T</div><div class="sd-cell sd-snp">A</div>
                         <div class="sd-cell sd-label">S2</div><div class="sd-cell sd-snp">A</div><div class="sd-cell sd-base">A</div><div class="sd-cell sd-snp">T</div><div class="sd-cell sd-snp">T</div><div class="sd-cell sd-gap sd-excluded">—</div><div class="sd-cell sd-base">T</div><div class="sd-cell sd-snp">C</div>
                         <div class="sd-cell sd-label">S3</div><div class="sd-cell sd-base">T</div><div class="sd-cell sd-gap">—</div><div class="sd-cell sd-base">G</div><div class="sd-cell sd-base">C</div><div class="sd-cell sd-gap sd-excluded">—</div><div class="sd-cell sd-snp">A</div><div class="sd-cell sd-snp">A</div>
                         <div class="sd-cell sd-legend">✗ <strong>Pos 5</strong> excluded: ALL samples have gap → <strong>6 usable positions</strong> remain</div>
                         <div class="sd-cell sd-legend" style="border-bottom:none;">✓ Pos 2: S1,S3 have gap but S2 has data → <strong>kept</strong> (only gap samples excluded from comparison)</div>
                       </div>`
            },
            'pp_gi_total': {
                title: 'Gap-Intersect — Total SNPs',
                body: `<p>Positions in usable space where <strong>at least 1 sample</strong> has an alt allele vs reference in this pipeline.</p>
                       <div class="formula">Total SNPs = Consensus + Discriminating</div>`
            },
            'pp_gi_consensus': {
                title: 'Gap-Intersect — Consensus SNPs',
                body: `<p>Positions where all samples <strong>with data</strong> (no gap) agree on the same alt allele.</p>
                       <p>Samples with a gap at the position are ignored. Among the remaining, all must have the same alt allele.</p>`
            },
            'pp_gi_disc': {
                title: 'Gap-Intersect — Discriminating SNPs',
                body: `<p>Positions where samples <strong>differ</strong>, considering only samples without a gap at each position.</p>
                       <ul style="margin:5px 0;padding-left:20px;font-size:12px;">
                           <li>Fewer than 2 samples with data → <strong>not counted</strong></li>
                           <li>All agree → <strong>consensus</strong></li>
                           <li>At least 2 differ → <strong>discriminating</strong></li>
                       </ul>
                       <p><strong>Breakdown (when breakdown available):</strong></p>
                       <table style="width:100%;font-size:11px;border-collapse:collapse;margin:8px 0;">
                       <tr style="background:var(--bg-tertiary);"><th style="padding:4px 6px;text-align:left;">Heuristic</th><th style="padding:4px 6px;text-align:left;">Description</th><th style="padding:4px 6px;text-align:left;">Example (Ref=T, 4 samples)</th></tr>
                       <tr style="border-bottom:1px solid var(--border-color);">
                           <td style="padding:4px 6px;font-weight:600;">Gap-affected</td>
                           <td style="padding:4px 6px;">≥1 sample skipped due to gap, comparison is partial</td>
                           <td style="padding:4px 6px;font-family:monospace;">VCF: A, A, <span style="color:#e6862a;">gap</span>, T → 2 samples differ (A vs T) but one was skipped. Without the gap the result might change.</td>
                       </tr>
                       <tr style="border-bottom:1px solid var(--border-color);">
                           <td style="padding:4px 6px;font-weight:600;">Ref-consensus</td>
                           <td style="padding:4px 6px;">Ref pileup shows all samples agree — variant calling artifact</td>
                           <td style="padding:4px 6px;font-family:monospace;">VCF: A, A, A, <span style="color:#e6862a;">ref</span> → discriminating (3×A vs 1×ref).<br>Ref pileup: A, A, A, A → all agree. The VCF missed the call in sample 4.</td>
                       </tr>
                       <tr style="border-bottom:1px solid var(--border-color);">
                           <td style="padding:4px 6px;font-weight:600;">Majority-rule</td>
                           <td style="padding:4px 6px;">All but one sample agree — likely single-sample VC miss</td>
                           <td style="padding:4px 6px;font-family:monospace;">VCF: A, A, A, <span style="color:#e6862a;">ref</span> → 3 agree on A, 1 has ref. No Ref data to confirm, but the majority suggests the 4th sample missed the call.</td>
                       </tr>
                       <tr>
                           <td style="padding:4px 6px;font-weight:600;">Confirmed</td>
                           <td style="padding:4px 6px;">Genuine disagreement — none of the above apply</td>
                           <td style="padding:4px 6px;font-family:monospace;">VCF: A, A, G, G → 2×A vs 2×G. Ref also shows disagreement. Real biological variation between samples.</td>
                       </tr>
                       </table>`
            },
            'pp_gu_usable': {
                title: 'Gap-Union — Usable Space',
                body: `<p>Reference positions remaining after removing those where <strong>at least 1 sample</strong> has a gap in this pipeline.</p>
                       <div class="formula">Usable Space = Reference Length − union(pipeline gaps of all samples)</div>
                       <p>Most restrictive: a position is excluded if any sample has a gap there.</p>
                       <div class="strategy-diagram" style="grid-template-columns: auto repeat(7, 1fr);">
                         <div class="sd-cell sd-header"></div><div class="sd-cell sd-header">Pos 1</div><div class="sd-cell sd-header">Pos 2</div><div class="sd-cell sd-header">Pos 3</div><div class="sd-cell sd-header">Pos 4</div><div class="sd-cell sd-header">Pos 5</div><div class="sd-cell sd-header">Pos 6</div><div class="sd-cell sd-header">Pos 7</div>
                         <div class="sd-cell sd-label">Ref</div><div class="sd-cell">T</div><div class="sd-cell sd-excluded">A</div><div class="sd-cell">G</div><div class="sd-cell">C</div><div class="sd-cell sd-excluded">A</div><div class="sd-cell">T</div><div class="sd-cell">G</div>
                         <div class="sd-cell sd-label">S1</div><div class="sd-cell sd-snp">A</div><div class="sd-cell sd-gap sd-excluded">—</div><div class="sd-cell sd-base">G</div><div class="sd-cell sd-snp">T</div><div class="sd-cell sd-gap sd-excluded">—</div><div class="sd-cell sd-base">T</div><div class="sd-cell sd-snp">A</div>
                         <div class="sd-cell sd-label">S2</div><div class="sd-cell sd-snp">A</div><div class="sd-cell sd-excluded">A</div><div class="sd-cell sd-snp">T</div><div class="sd-cell sd-snp">T</div><div class="sd-cell sd-gap sd-excluded">—</div><div class="sd-cell sd-base">T</div><div class="sd-cell sd-snp">C</div>
                         <div class="sd-cell sd-label">S3</div><div class="sd-cell sd-base">T</div><div class="sd-cell sd-gap sd-excluded">—</div><div class="sd-cell sd-base">G</div><div class="sd-cell sd-base">C</div><div class="sd-cell sd-gap sd-excluded">—</div><div class="sd-cell sd-snp">A</div><div class="sd-cell sd-snp">A</div>
                         <div class="sd-cell sd-legend">✗ <strong>Pos 2, 5</strong> excluded: at least 1 sample has gap → <strong>5 usable positions</strong> remain</div>
                         <div class="sd-cell sd-legend" style="border-bottom:none;">Compare with Gap-Intersect: same data but Pos 2 is kept there (only Pos 5 excluded)</div>
                       </div>`
            },
            'pp_gu_total': {
                title: 'Gap-Union — Total SNPs',
                body: `<p>Positions in usable space where <strong>at least 1 sample</strong> has an alt allele vs reference in this pipeline.</p>
                       <div class="formula">Total SNPs = Consensus + Discriminating</div>`
            },
            'pp_gu_consensus': {
                title: 'Gap-Union — Consensus SNPs',
                body: `<p>Positions where <strong>ALL samples</strong> have the same alt allele. No sample can have a gap here (they were all excluded by the union).</p>`
            },
            'pp_gu_disc': {
                title: 'Gap-Union — Discriminating SNPs',
                body: `<p>Positions where samples <strong>differ</strong> in alt allele or SNP presence. All samples have data (no gaps in usable space).</p>
                       <p><strong>Breakdown (when breakdown available):</strong></p>
                       <table style="width:100%;font-size:11px;border-collapse:collapse;margin:8px 0;">
                       <tr style="background:var(--bg-tertiary);"><th style="padding:4px 6px;text-align:left;">Heuristic</th><th style="padding:4px 6px;text-align:left;">Description</th><th style="padding:4px 6px;text-align:left;">Example (Ref=T, 4 samples)</th></tr>
                       <tr style="border-bottom:1px solid var(--border-color);">
                           <td style="padding:4px 6px;font-weight:600;">Ref-consensus</td>
                           <td style="padding:4px 6px;">Ref pileup shows all samples agree — variant calling artifact</td>
                           <td style="padding:4px 6px;font-family:monospace;">VCF: A, A, A, <span style="color:#e6862a;">ref</span> → discriminating.<br>Ref pileup: A, A, A, A → all agree. The variant caller missed the SNP in sample 4.</td>
                       </tr>
                       <tr style="border-bottom:1px solid var(--border-color);">
                           <td style="padding:4px 6px;font-weight:600;">Majority-rule</td>
                           <td style="padding:4px 6px;">All but one sample agree — likely single-sample VC miss</td>
                           <td style="padding:4px 6px;font-family:monospace;">VCF: A, A, A, <span style="color:#e6862a;">ref</span> → 3×A vs 1×ref. No Ref data to confirm, but the majority suggests the 4th missed the call.</td>
                       </tr>
                       <tr>
                           <td style="padding:4px 6px;font-weight:600;">Confirmed</td>
                           <td style="padding:4px 6px;">Genuine disagreement — none of the above apply</td>
                           <td style="padding:4px 6px;font-family:monospace;">VCF: A, A, G, G → 2×A vs 2×G. Ref also shows disagreement. Real biological variation.</td>
                       </tr>
                       </table>
                       <p style="font-size:11px;color:var(--text-secondary);"><em>Note: Gap-affected is always 0 in Gap-Union because all positions with any gap are already excluded from usable space.</em></p>`
            },
            'pp_pw_usable': {
                title: 'Pairwise (Gap-Union) — Avg Usable Space',
                body: `<p>Average usable genome space across all sample pairs for this pipeline.</p>
                       <div class="formula">For each pair (A, B): Usable = RefLength − union(gaps A, gaps B)</div>
                       <p>Each pair has its own gap exclusion — different pairs can have different usable space:</p>
                       <div class="strategy-diagram" style="grid-template-columns: auto repeat(7, 1fr);">
                         <div class="sd-cell sd-header" style="grid-column:1/-1;text-align:left;font-size:11px;">Pair S1 vs S2</div>
                         <div class="sd-cell sd-header"></div><div class="sd-cell sd-header">Pos 1</div><div class="sd-cell sd-header">Pos 2</div><div class="sd-cell sd-header">Pos 3</div><div class="sd-cell sd-header">Pos 4</div><div class="sd-cell sd-header">Pos 5</div><div class="sd-cell sd-header">Pos 6</div><div class="sd-cell sd-header">Pos 7</div>
                         <div class="sd-cell sd-label">S1</div><div class="sd-cell sd-snp">A</div><div class="sd-cell sd-gap sd-excluded">—</div><div class="sd-cell sd-base">G</div><div class="sd-cell sd-snp">T</div><div class="sd-cell sd-gap sd-excluded">—</div><div class="sd-cell sd-base">T</div><div class="sd-cell sd-snp">A</div>
                         <div class="sd-cell sd-label">S2</div><div class="sd-cell sd-snp">A</div><div class="sd-cell sd-excluded">A</div><div class="sd-cell sd-snp">T</div><div class="sd-cell sd-snp">T</div><div class="sd-cell sd-gap sd-excluded">—</div><div class="sd-cell sd-base">T</div><div class="sd-cell sd-snp">C</div>
                         <div class="sd-cell sd-legend">✗ Pos 2 (S1 gap), Pos 5 (both gap) → <strong>5 usable</strong>, Pos 3,7 differ → <strong>2 disc SNPs</strong></div>
                       </div>
                       <div class="strategy-diagram" style="grid-template-columns: auto repeat(7, 1fr);">
                         <div class="sd-cell sd-header" style="grid-column:1/-1;text-align:left;font-size:11px;">Pair S1 vs S3</div>
                         <div class="sd-cell sd-header"></div><div class="sd-cell sd-header">Pos 1</div><div class="sd-cell sd-header">Pos 2</div><div class="sd-cell sd-header">Pos 3</div><div class="sd-cell sd-header">Pos 4</div><div class="sd-cell sd-header">Pos 5</div><div class="sd-cell sd-header">Pos 6</div><div class="sd-cell sd-header">Pos 7</div>
                         <div class="sd-cell sd-label">S1</div><div class="sd-cell sd-snp">A</div><div class="sd-cell sd-gap sd-excluded">—</div><div class="sd-cell sd-base">G</div><div class="sd-cell sd-snp">T</div><div class="sd-cell sd-gap sd-excluded">—</div><div class="sd-cell sd-base">T</div><div class="sd-cell sd-snp">A</div>
                         <div class="sd-cell sd-label">S3</div><div class="sd-cell sd-base">T</div><div class="sd-cell sd-gap sd-excluded">—</div><div class="sd-cell sd-base">G</div><div class="sd-cell sd-base">C</div><div class="sd-cell sd-gap sd-excluded">—</div><div class="sd-cell sd-snp">A</div><div class="sd-cell sd-snp">A</div>
                         <div class="sd-cell sd-legend" style="border-bottom:none;">✗ Pos 2 (both gap), Pos 5 (both gap) → <strong>5 usable</strong>, Pos 1,4,6 differ → <strong>3 disc SNPs</strong></div>
                       </div>
                       <p style="font-size:11px;color:var(--text-secondary);">Avg usable = (5+5)/2 = 5.0 — Avg disc SNPs = (2+3)/2 = 2.5</p>`
            },
            'pp_pw_disc': {
                title: 'Pairwise (Gap-Union) — Discriminating SNPs',
                body: `<p>Pairwise discriminating SNP statistics for this pipeline.</p>
                       <div class="formula">For each pair (A, B): count positions where A ≠ B, not in pair's gap union</div>
                       <p>Shows average, minimum, median, and maximum across all pairs.</p>`
            },
            'pp_ps_table': {
                title: 'Per-Sample Pairwise Breakdown',
                body: `<p>For each sample S, averages are computed across all (N−1) pairs involving S.</p>
                       <ul style="margin:5px 0;padding-left:20px;font-size:12px;">
                           <li><strong>Avg Usable Space:</strong> average usable bp across pairs involving this sample</li>
                           <li><strong>Avg Discriminating SNPs:</strong> average discriminating SNPs across pairs involving this sample</li>
                       </ul>
                       <p>A sample with high avg discriminating SNPs is more distant from the others.</p>`
            },
            'gt_disc_vs_pl': {
                title: 'Ref Discriminating SNPs vs Pipelines',
                body: `<p>For each gap strategy, compares <strong>Ref discriminating SNPs</strong> against each pipeline's core SNP positions:</p>
                       <ul>
                           <li><strong>Ref Disc:</strong> number of Ref discriminating positions in the usable space</li>
                           <li><strong>Same Pos:</strong> how many Ref disc positions also exist in the pipeline's core SNP list (overlap)</li>
                           <li><strong>Concordant:</strong> among Same Pos, how many positions have the <em>same allele for every sample</em> in both Ref and pipeline. A position is concordant only if Ref and pipeline agree on the called base for all samples. Low concordance (e.g. 0) can occur when the pipeline has gaps where the Ref calls a base.</li>
                           <li><strong>In Ref Gaps:</strong> pipeline core SNP positions that fall within Ref gap regions</li>
                       </ul>`
            },
            'pl_disc_snps': {
                title: 'Pipeline Discriminating SNPs',
                body: `<p><strong>Disc. SNPs</strong> counts discriminating positions within the pipeline's own core SNP output.</p>
                       <p>For each core SNP position, samples with gaps or N are removed. Among the remaining samples, the position is <strong>discriminating</strong> if at least 2 samples have different alleles.</p>
                       <p>This value can be 0 even when <strong>Same Pos &gt; 0</strong> because:</p>
                       <ul>
                           <li><strong>Disc. SNPs</strong> uses the pipeline's own allele calls (e.g. from snpma.fasta or core.tab)</li>
                           <li><strong>Same Pos</strong> counts Ref discriminating positions that overlap with the pipeline's core SNP positions — the Ref may see discordance (from BAM pileup) at positions where the pipeline has gaps for some samples</li>
                       </ul>
                       <p>In other words: the Ref calls a base where the pipeline has a gap, so the Ref sees discordance that the pipeline cannot detect.</p>`
            },
            'pl_lost_snps': {
                title: 'Lost Discriminating SNPs',
                body: `<p><strong>Lost</strong> = Disc. SNPs − Same Pos − In Ref Gaps</p>
                       <p>Pipeline discriminating SNPs that the Ref neither confirms (Same Pos) nor explains by gap regions (In Ref Gaps).</p>
                       <p>These are positions where the pipeline sees allele variation, but the Ref does not see them as discriminating — they may be false positives from the pipeline, or positions where the Ref calls all samples as consensus.</p>`
            },
            'gt_disc_gi': {
                title: 'Gap-Intersect Strategy',
                body: `<p>Ref discriminating positions computed using <strong>Gap-Intersect</strong>: only positions where ALL samples have a Ref gap are excluded.</p>
                       <p>More permissive — positions where some (but not all) samples have gaps are still evaluated among the non-gap samples.</p>
                       <div class="strategy-diagram" style="grid-template-columns: auto repeat(5, 1fr);">
                         <div class="sd-cell sd-header"></div><div class="sd-cell sd-header">Pos 1</div><div class="sd-cell sd-header">Pos 2</div><div class="sd-cell sd-header">Pos 3</div><div class="sd-cell sd-header">Pos 4</div><div class="sd-cell sd-header">Pos 5</div>
                         <div class="sd-cell sd-label">S1</div><div class="sd-cell sd-snp">A</div><div class="sd-cell sd-gap">—</div><div class="sd-cell sd-snp">T</div><div class="sd-cell sd-gap sd-excluded">—</div><div class="sd-cell sd-snp">A</div>
                         <div class="sd-cell sd-label">S2</div><div class="sd-cell sd-snp">A</div><div class="sd-cell sd-snp">C</div><div class="sd-cell sd-snp">G</div><div class="sd-cell sd-gap sd-excluded">—</div><div class="sd-cell sd-snp">A</div>
                         <div class="sd-cell sd-label">S3</div><div class="sd-cell sd-base">T</div><div class="sd-cell sd-gap">—</div><div class="sd-cell sd-snp">T</div><div class="sd-cell sd-gap sd-excluded">—</div><div class="sd-cell sd-base">T</div>
                         <div class="sd-cell sd-legend">✗ Pos 4: ALL have gap → excluded</div>
                         <div class="sd-cell sd-legend">✓ Pos 2: S1,S3 gap → excluded from check; S2 alone → not disc</div>
                         <div class="sd-cell sd-legend" style="border-bottom:none;">✓ Pos 3: S1,S2 differ (T vs G) → <strong>discriminating</strong></div>
                       </div>
                       <p><strong>In Ref Gaps</strong> counts pipeline SNPs falling in the Ref gap-intersection set.</p>`
            },
            'gt_disc_gu': {
                title: 'Gap-Union Strategy',
                body: `<p>Ref discriminating positions computed using <strong>Gap-Union</strong>: positions where ANY sample has a Ref gap are excluded.</p>
                       <p>More strict — all samples must have data at a position for it to be considered.</p>
                       <div class="strategy-diagram" style="grid-template-columns: auto repeat(5, 1fr);">
                         <div class="sd-cell sd-header"></div><div class="sd-cell sd-header">Pos 1</div><div class="sd-cell sd-header">Pos 2</div><div class="sd-cell sd-header">Pos 3</div><div class="sd-cell sd-header">Pos 4</div><div class="sd-cell sd-header">Pos 5</div>
                         <div class="sd-cell sd-label">S1</div><div class="sd-cell sd-snp">A</div><div class="sd-cell sd-gap sd-excluded">—</div><div class="sd-cell sd-snp">T</div><div class="sd-cell sd-gap sd-excluded">—</div><div class="sd-cell sd-snp">A</div>
                         <div class="sd-cell sd-label">S2</div><div class="sd-cell sd-snp">A</div><div class="sd-cell sd-excluded">C</div><div class="sd-cell sd-snp">G</div><div class="sd-cell sd-gap sd-excluded">—</div><div class="sd-cell sd-snp">A</div>
                         <div class="sd-cell sd-label">S3</div><div class="sd-cell sd-base">T</div><div class="sd-cell sd-gap sd-excluded">—</div><div class="sd-cell sd-snp">T</div><div class="sd-cell sd-gap sd-excluded">—</div><div class="sd-cell sd-base">T</div>
                         <div class="sd-cell sd-legend">✗ Pos 2: S1,S3 have gap → excluded (any gap = out)</div>
                         <div class="sd-cell sd-legend">✗ Pos 4: ALL have gap → excluded</div>
                         <div class="sd-cell sd-legend" style="border-bottom:none;">→ <strong>3 usable</strong> (vs 4 in Gap-Intersect with same data)</div>
                       </div>
                       <p><strong>In Ref Gaps</strong> counts pipeline SNPs falling in the Ref gap-union set.</p>`
            },
            'gt_disc_pw': {
                title: 'Pairwise Strategy',
                body: `<p>For each pair of samples, Ref discriminating positions are computed using <strong>pairwise Gap-Union</strong> (excluding positions where either sample has a gap).</p>
                       <p>Values shown are <strong>averages</strong> across all sample pairs. No "In Ref Gaps" column — it would be the same per pipeline regardless of pair.</p>`
            }
        };

        function showKpiInfo(kpiType) {
            const info = kpiDescriptions[kpiType];
            if (!info) return;

            document.getElementById('info-modal-title').textContent = info.title;
            document.getElementById('info-modal-body').innerHTML = info.body;
            document.getElementById('info-modal').classList.add('active');
        }

        function closeInfoModal() {
            document.getElementById('info-modal').classList.remove('active');
        }

        function closeDetailModal() {
            document.getElementById('detail-modal').classList.remove('active');
        }

        async function showGtDiscDetail(plId, strategy, statusFilter) {
            const modal = document.getElementById('detail-modal');
            const title = document.getElementById('detail-modal-title');
            const body = document.getElementById('detail-modal-body');
            const plLabel = (workerApi.cachedData.pipelineInfo &&
                workerApi.cachedData.pipelineInfo[plId] &&
                workerApi.cachedData.pipelineInfo[plId].label) || plId;
            const strategyLabel = strategy === 'gap_union' ? 'Gap-Union' : 'Gap-Intersect';

            title.textContent = `${plLabel} — ${strategyLabel} — ${statusFilter} positions`;
            body.innerHTML = '<div class="detail-loading">Loading position details...</div>';
            modal.classList.add('active');

            try {
                const data = await workerApi.getGtDiscPositionDetails(plId, strategy);
                if (!data || !data.positions || data.positions.length === 0) {
                    body.innerHTML = '<p style="color:var(--text-secondary)">No position data available.</p>';
                    return;
                }

                const samples = data.samples || [];
                const sampleLabels = workerApi.cachedData.sampleLabels || {};

                // Count by status
                const counts = {};
                for (const p of data.positions) {
                    counts[p.status] = (counts[p.status] || 0) + 1;
                }

                // Filter buttons
                const statusLabels = {
                    'all': 'All',
                    'concordant': 'Concordant',
                    'discordant': 'Discordant',
                    'not_disc_in_pl': 'Not Disc. in PL',
                    'lost': 'Not in PL',
                    'in_gt_gap': 'In Ref Gaps',
                    'in_pl_gap': 'In PL Gaps',
                    'pl_only': 'Lost (PL only)'
                };
                let filterHtml = '<div class="filter-bar">';
                filterHtml += `<button class="filter-btn${statusFilter === 'all' ? ' active' : ''}" onclick="filterGtDiscPositions('all')">All (${data.positions.length})</button>`;
                for (const [st, label] of Object.entries(statusLabels)) {
                    if (st === 'all') continue;
                    if (!counts[st]) continue;
                    filterHtml += `<button class="filter-btn${statusFilter === st ? ' active' : ''}" onclick="filterGtDiscPositions('${st}')">${label} (${counts[st]})</button>`;
                }
                filterHtml += '<span style="margin-left:auto;display:flex;gap:4px;align-items:center;">';
                filterHtml += '<input type="text" id="pos-search" placeholder="Search position..." style="width:130px;padding:3px 8px;border:1px solid var(--border-color);border-radius:4px;background:var(--bg-tertiary);color:var(--text-primary);font-size:12px;" oninput="applyPosSearch()">';
                filterHtml += '<button class="filter-btn" onclick="exportGtDiscPositions(\'tsv\')" title="Export as TSV">TSV</button>';
                filterHtml += '<button class="filter-btn" onclick="exportGtDiscPositions(\'csv\')" title="Export as CSV">CSV</button>';
                filterHtml += '</span>';
                filterHtml += '</div>';

                // Gap-Intersect footnote
                if (strategy === 'gap_intersect') {
                    filterHtml += '<div style="font-size:11px;color:var(--text-secondary);padding:4px 8px;margin-top:2px;">'
                        + '<strong>Note:</strong> Gap-Intersect skips a position only when <em>all</em> samples have a gap there. '
                        + 'When only some samples have a gap, those samples are excluded from the concordance check and the remaining samples (≥2) are compared. '
                        + 'This is why you may see "-" alleles alongside a concordant/discordant status.'
                        + '</div>';
                }

                // Filter positions by status and position search
                const posSearch = (window._gtDiscPosSearch || '').replace(/,/g, '').trim();
                let filtered = statusFilter === 'all'
                    ? data.positions
                    : data.positions.filter(p => p.status === statusFilter);
                if (posSearch) {
                    filtered = filtered.filter(p => String(p.pos).includes(posSearch));
                }

                // Update title with count
                title.textContent = `${plLabel} — ${strategyLabel} — ${filtered.length} ${statusFilter === 'all' ? 'total' : statusFilter} positions`;

                // Build table
                let tbl = '<table><thead><tr><th>Pos</th><th>Ref</th>';
                for (const s of samples) {
                    const lbl = sampleLabels[s] || s;
                    tbl += `<th>${lbl}<br><span style="font-size:10px;color:var(--text-secondary)">Ref→PL</span></th>`;
                }
                tbl += '<th>Status</th></tr></thead><tbody>';

                for (const p of filtered) {
                    tbl += `<tr><td style="text-align:right">${p.pos.toLocaleString()}</td><td>${p.ref}</td>`;
                    for (const s of samples) {
                        const gtA = (p.gt && p.gt[s]) || '?';
                        const plA = (p.pl && p.pl[s]) || '?';
                        const mismatch = gtA !== '-' && plA !== '-' && gtA !== plA;
                        const gapClass = (gtA === '-' || plA === '-') ? ' allele-gap' : '';
                        const cls = mismatch ? ' allele-mismatch' : gapClass;
                        tbl += `<td class="${cls}">${gtA}→${plA}</td>`;
                    }
                    tbl += `<td class="status-${p.status}">${p.status}</td></tr>`;
                }

                tbl += '</tbody></table>';
                body.innerHTML = filterHtml + tbl;

                // Store data for filter switching and export
                window._gtDiscDetailData = data;
                window._gtDiscDetailPlId = plId;
                window._gtDiscDetailStrategy = strategy;
                window._gtDiscDetailStatusFilter = statusFilter;

                // Restore search text
                const posInput = document.getElementById('pos-search');
                if (posInput && window._gtDiscPosSearch) {
                    posInput.value = window._gtDiscPosSearch;
                }

            } catch (err) {
                body.innerHTML = `<p style="color:#f44336">Error: ${err.message}</p>`;
            }
        }

        function filterGtDiscPositions(status) {
            if (!window._gtDiscDetailData) return;
            showGtDiscDetail(
                window._gtDiscDetailPlId,
                window._gtDiscDetailStrategy,
                status
            );
        }

        let _posSearchTimeout = null;
        function applyPosSearch() {
            // Debounce: wait 300ms after user stops typing
            if (_posSearchTimeout) clearTimeout(_posSearchTimeout);
            _posSearchTimeout = setTimeout(() => {
                const input = document.getElementById('pos-search');
                window._gtDiscPosSearch = input ? input.value : '';
                if (!window._gtDiscDetailData) return;
                showGtDiscDetail(
                    window._gtDiscDetailPlId,
                    window._gtDiscDetailStrategy,
                    window._gtDiscDetailStatusFilter || 'all'
                );
            }, 300);
        }

        function exportGtDiscPositions(format) {
            const data = window._gtDiscDetailData;
            if (!data || !data.positions) return;
            const samples = data.samples || [];
            const sampleLabels = workerApi.cachedData.sampleLabels || {};
            const statusFilter = window._gtDiscDetailStatusFilter || 'all';
            const posSearch = (window._gtDiscPosSearch || '').replace(/,/g, '').trim();
            let filtered = statusFilter === 'all'
                ? data.positions
                : data.positions.filter(p => p.status === statusFilter);
            if (posSearch) {
                filtered = filtered.filter(p => String(p.pos).includes(posSearch));
            }

            const sep = format === 'csv' ? ',' : '\t';
            const ext = format === 'csv' ? 'csv' : 'tsv';

            // Header
            const headers = ['pos', 'ref'];
            for (const s of samples) {
                const lbl = sampleLabels[s] || s;
                headers.push(`${lbl}_GT`, `${lbl}_PL`);
            }
            headers.push('status');

            const rows = [headers.join(sep)];
            for (const p of filtered) {
                const row = [p.pos, p.ref];
                for (const s of samples) {
                    row.push((p.gt && p.gt[s]) || '?');
                    row.push((p.pl && p.pl[s]) || '?');
                }
                row.push(p.status);
                rows.push(row.join(sep));
            }

            const blob = new Blob([rows.join('\n')], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            const plLabel = (workerApi.cachedData.pipelineInfo &&
                workerApi.cachedData.pipelineInfo[window._gtDiscDetailPlId] &&
                workerApi.cachedData.pipelineInfo[window._gtDiscDetailPlId].label) || window._gtDiscDetailPlId;
            a.href = url;
            a.download = `gt_disc_${plLabel}_${window._gtDiscDetailStrategy}_${statusFilter}.${ext}`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Close modal on Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') { closeInfoModal(); closeDetailModal(); }
        });

        // Scroll to top button
        function scrollToTop() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        window.addEventListener('scroll', () => {
            const btn = document.getElementById('scroll-top-btn');
            if (window.scrollY > 300) {
                btn.classList.add('visible');
            } else {
                btn.classList.remove('visible');
            }
        });
    </script>

    <script>
        // Worker-based architecture for non-blocking UI
        // All heavy WASM operations run in a separate thread

        // Worker API - promise-based interface to the worker
        class WorkerAPI {
            constructor() {
                this.worker = new Worker('./worker.js', { type: 'module' });
                this.pending = new Map();
                this.nextId = 0;
                this.ready = false;
                this.cachedData = {}; // Cache for frequently accessed data

                this.worker.onmessage = (e) => {
                    const { id, success, result, error } = e.data;
                    const resolver = this.pending.get(id);
                    if (resolver) {
                        this.pending.delete(id);
                        if (success) {
                            resolver.resolve(result);
                        } else {
                            resolver.reject(new Error(error));
                        }
                    }
                };
            }

            send(action, payload = {}) {
                return new Promise((resolve, reject) => {
                    const id = this.nextId++;
                    this.pending.set(id, { resolve, reject });
                    this.worker.postMessage({ id, action, payload });
                });
            }

            async init() {
                const result = await this.send('init');
                this.ready = result.success;
                return this.ready;
            }

            async loadBinary(data) {
                const result = await this.send('loadBinary', { data });
                this.cachedData = result; // Cache all the basic info
                return result;
            }

            async loadJson(json) {
                const result = await this.send('loadJson', { json });
                this.cachedData = result;
                return result;
            }

            async getPipelineInfo(pipelineIds) {
                return await this.send('getPipelineInfo', { pipelineIds });
            }

            async getSampleLabel(sampleId) {
                return (await this.send('getSampleLabel', { sampleId })).label;
            }

            async getPipelineLabel(pipelineId) {
                return (await this.send('getPipelineLabel', { pipelineId })).label;
            }

            async getKpis() {
                return (await this.send('getKpis')).kpis;
            }

            async getGlobalStats() {
                return (await this.send('getGlobalStats')).stats;
            }

            async getPairwiseUsableStats() {
                return (await this.send('getPairwiseUsableStats')).stats;
            }

            async getGlobalStatsForPipeline(pipelineId) {
                return (await this.send('getGlobalStatsForPipeline', { pipelineId })).stats;
            }

            async getPairwiseUsableStatsForPipeline(pipelineId) {
                return (await this.send('getPairwiseUsableStatsForPipeline', { pipelineId })).stats;
            }

            async getGtDiscVsPipelines() {
                return (await this.send('getGtDiscVsPipelines', {})).stats;
            }

            async getGtDiscPositionDetails(pipelineId, strategy) {
                return (await this.send('getGtDiscPositionDetails', { pipelineId, strategy })).details;
            }

            // Cached accessors (no worker call needed after load)
            get refName() { return this.cachedData.refName; }
            get refLength() { return this.cachedData.refLength; }
            get sampleIds() { return this.cachedData.sampleIds; }
            get pipelineIds() { return this.cachedData.pipelineIds; }
            get generatedAt() { return this.cachedData.generatedAt; }
            get description() { return this.cachedData.description; }
            get configYaml() { return this.cachedData.configYaml; }
            get pileupOptions() { return this.cachedData.pileupOptions; }
            get warnings() { return this.cachedData.warnings; }
            get vcfPipelines() { return this.cachedData.vcfPipelines; }
            get referencePipeline() { return this.cachedData.referencePipeline; }
            get pipelineDistanceMatrices() { return this.cachedData.pipelineDistanceMatrices; }
            get pipelineInfo() { return this.cachedData.pipelineInfo; }
            get sampleLabels() { return this.cachedData.sampleLabels; }

            // Helper methods for cached data
            getPipelineLabel(pipelineId) {
                return this.cachedData.pipelineInfo?.[pipelineId]?.label || pipelineId;
            }
            getPipelineCommand(pipelineId) {
                return this.cachedData.pipelineInfo?.[pipelineId]?.command || '';
            }
            isReference(pipelineId) {
                return this.cachedData.pipelineInfo?.[pipelineId]?.isReference || false;
            }
            isFromBamPileup(pipelineId) {
                return this.cachedData.pipelineInfo?.[pipelineId]?.isFromBamPileup || false;
            }
            getSampleLabel(sampleId) {
                return this.cachedData.sampleLabels?.[sampleId] || sampleId;
            }
        }

        let workerApi = null;
        let samples = [];

        let pipelines = [];

        function showLoader(text, progress = '') {
            document.getElementById('loader').classList.add('active');
            document.getElementById('loader-text').textContent = text;
            document.getElementById('loader-progress').textContent = progress;
        }

        function hideLoader() {
            document.getElementById('loader').classList.remove('active');
        }

        function goToLanding(fromPopState = false) {
            document.getElementById('viewer').classList.add('hidden');
            document.getElementById('drop-zone').classList.remove('hidden');
            // Update URL without adding to history (unless triggered by back button)
            if (!fromPopState) {
                history.replaceState({ view: 'landing' }, '', window.location.pathname);
            }
        }

        // Progressive loading helpers
        function setSectionLoading(containerId, isLoading, message = 'Loading...') {
            const container = document.getElementById(containerId);
            if (!container) return;
            if (isLoading) {
                container.innerHTML = `<div class="section-loading"><span class="mini-spinner"></span>${message}</div>`;
            }
        }

        function scheduleIdleTask(callback, timeout = 2000) {
            if ('requestIdleCallback' in window) {
                requestIdleCallback(callback, { timeout });
            } else {
                setTimeout(callback, 10);
            }
        }

        // Progressive UI builder - shows UI immediately, then populates sections
        async function buildUIProgressively() {
            const t0 = performance.now();

            // Phase 1: Show viewer immediately with loading states
            document.getElementById('drop-zone').classList.add('hidden');
            document.getElementById('viewer').classList.remove('hidden');

            // Push history state so browser back button returns to landing
            history.pushState({ view: 'viewer' }, '', '#viewer');

            // Set loading placeholders for all sections
            setSectionLoading('pipelines-info', true, 'Loading pipelines...');
            setSectionLoading('kpis', true, 'Calculating statistics...');
            setSectionLoading('matrix-result', true, 'Ready to display');

            // Phase 2: Quick stuff first (instant)
            await nextFrame();
            populateDescription();
            populateConfig();
            displayWarnings();
            console.log(`Phase 2 (description): ${(performance.now() - t0).toFixed(0)}ms`);

            // Phase 3: Pipeline info (fast)
            await nextFrame();
            populatePipelineInfo();
            populateAllMatrices();
            console.log(`Phase 3 (pipelines): ${(performance.now() - t0).toFixed(0)}ms`);

            // Phase 4: KPIs (medium)
            await nextFrame();
            await updateKPIs();
            console.log(`Phase 4 (KPIs): ${(performance.now() - t0).toFixed(0)}ms`);

            // Hide loader - core UI is now visible
            hideLoader();

            console.log(`UI build complete: ${(performance.now() - t0).toFixed(0)}ms`);
        }

        function nextFrame() {
            return new Promise(r => requestAnimationFrame(() => requestAnimationFrame(r)));
        }

        async function main() {
            workerApi = new WorkerAPI();
            showLoader('Initializing...', 'Loading WASM module');
            const success = await workerApi.init();
            if (!success) {
                alert('Failed to initialize WASM module');
                return;
            }
            hideLoader();
            console.log('Worker + WASM initialized');
            setupDropZone();
            setupFileInput();

            // Handle browser back button
            window.addEventListener('popstate', (e) => {
                if (!e.state || e.state.view !== 'viewer') {
                    goToLanding(true);
                }
            });
        }

        function setupDropZone() {
            const dropZone = document.getElementById('drop-zone');

            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                });
            });

            ['dragenter', 'dragover'].forEach(eventName => {
                dropZone.addEventListener(eventName, () => {
                    dropZone.classList.add('dragover');
                });
            });

            ['dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, () => {
                    dropZone.classList.remove('dragover');
                });
            });

            dropZone.addEventListener('drop', (e) => {
                const file = e.dataTransfer.files[0];
                if (file && (file.name.endsWith('.json') || file.name.endsWith('.json.gz') || file.name.endsWith('.bin') || file.name.endsWith('.bin.gz') || file.name.endsWith('.gz'))) {
                    loadFile(file);
                }
            });
        }

        function setupFileInput() {
            document.getElementById('file-input').addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    loadFile(file);
                }
            });
        }

        // Streaming decompression with progress updates (returns text)
        async function decompressGzipWithProgress(arrayBuffer, onProgress) {
            if (typeof DecompressionStream !== 'undefined') {
                // Native streaming decompression
                const stream = new Response(arrayBuffer).body
                    .pipeThrough(new DecompressionStream('gzip'));
                const reader = stream.getReader();
                const decoder = new TextDecoder();
                const chunks = [];
                let totalBytes = 0;

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    chunks.push(decoder.decode(value, { stream: true }));
                    totalBytes += value.length;
                    onProgress(totalBytes);
                    // Yield to UI every few MB
                    if (totalBytes % (2 * 1024 * 1024) < value.length) {
                        await new Promise(r => requestAnimationFrame(r));
                    }
                }
                chunks.push(decoder.decode()); // Flush
                return chunks.join('');
            }
            // Fallback to pako for older browsers
            const compressed = new Uint8Array(arrayBuffer);
            return pako.inflate(compressed, { to: 'string' });
        }

        // Streaming decompression for binary data (returns Uint8Array)
        async function decompressGzipBinary(arrayBuffer, onProgress) {
            if (typeof DecompressionStream !== 'undefined') {
                const stream = new Response(arrayBuffer).body
                    .pipeThrough(new DecompressionStream('gzip'));
                const reader = stream.getReader();
                const chunks = [];
                let totalBytes = 0;

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    chunks.push(value);
                    totalBytes += value.length;
                    onProgress(totalBytes);
                    if (totalBytes % (2 * 1024 * 1024) < value.length) {
                        await new Promise(r => requestAnimationFrame(r));
                    }
                }

                // Combine all chunks into single Uint8Array
                const totalLength = chunks.reduce((acc, chunk) => acc + chunk.length, 0);
                const result = new Uint8Array(totalLength);
                let offset = 0;
                for (const chunk of chunks) {
                    result.set(chunk, offset);
                    offset += chunk.length;
                }
                return result;
            }
            // Fallback to pako for older browsers
            const compressed = new Uint8Array(arrayBuffer);
            return pako.inflate(compressed);
        }

        // Detect if file is binary format based on filename
        function isBinaryFormat(filename) {
            return filename.endsWith('.bin') || filename.endsWith('.bin.gz');
        }

        async function loadDemo() {
            showLoader('Loading demo...', 'Fetching demo data');
            await new Promise(r => requestAnimationFrame(r));

            try {
                // Load JSON gzip format
                const response = await fetch('demo.json.gz');
                if (!response.ok) throw new Error('Failed to fetch demo file');

                const compressedSize = parseInt(response.headers.get('content-length') || '0');
                showLoader('Downloading...', `${(compressedSize / 1024 / 1024).toFixed(1)} MB compressed`);
                await new Promise(r => requestAnimationFrame(r));
                const arrayBuffer = await response.arrayBuffer();

                showLoader('Decompressing...', '0 MB');
                const jsonText = await decompressGzipWithProgress(arrayBuffer, (bytes) => {
                    showLoader('Decompressing...', `${(bytes / 1024 / 1024).toFixed(1)} MB`);
                });

                showLoader('Loading data...', `${(jsonText.length / 1024 / 1024).toFixed(0)} MB (in background)`);
                await new Promise(r => requestAnimationFrame(r));

                // Load in worker - UI stays responsive!
                await workerApi.loadJson(jsonText);

                showLoader('Preparing view...', '');
                await new Promise(r => requestAnimationFrame(r));

                // Use cached data from worker
                samples = workerApi.sampleIds;
                pipelines = workerApi.pipelineIds;

                document.getElementById('header-info').textContent =
                    `${workerApi.refName} (${workerApi.refLength.toLocaleString()} bp) | ${samples.length} samples | ${pipelines.length} pipelines`;

                // Set timestamp in footer
                const timestamp = workerApi.generatedAt;
                if (timestamp) {
                    const date = new Date(timestamp);
                    const dd = String(date.getDate()).padStart(2, '0');
                    const mm = String(date.getMonth() + 1).padStart(2, '0');
                    const yyyy = date.getFullYear();
                    const hh = String(date.getHours()).padStart(2, '0');
                    const mi = String(date.getMinutes()).padStart(2, '0');
                    const ss = String(date.getSeconds()).padStart(2, '0');
                    const formattedDate = `${dd}/${mm}/${yyyy} ${hh}:${mi}:${ss}`;
                    document.getElementById('report-timestamp').textContent =
                        `Report generated: ${formattedDate}`;
                }

                // Build UI progressively (loader hidden inside after core UI ready)
                await buildUIProgressively();

            } catch (error) {
                hideLoader();
                alert('Error loading demo: ' + error.message);
                console.error(error);
            }
        }
        // Expose to global scope for onclick
        window.loadDemo = loadDemo;

        async function loadDemo2() {
            showLoader('Loading demo 2...', 'Fetching demo data');
            await new Promise(r => requestAnimationFrame(r));

            try {
                // Load JSON gzip format
                const response = await fetch('demo2.json.gz');
                if (!response.ok) throw new Error('Failed to fetch demo2 file');

                const compressedSize = parseInt(response.headers.get('content-length') || '0');
                showLoader('Downloading...', `${(compressedSize / 1024 / 1024).toFixed(1)} MB compressed`);
                await new Promise(r => requestAnimationFrame(r));
                const arrayBuffer = await response.arrayBuffer();

                showLoader('Decompressing...', '0 MB');
                const jsonText = await decompressGzipWithProgress(arrayBuffer, (bytes) => {
                    showLoader('Decompressing...', `${(bytes / 1024 / 1024).toFixed(1)} MB`);
                });

                showLoader('Loading data...', `${(jsonText.length / 1024 / 1024).toFixed(0)} MB (in background)`);
                await new Promise(r => requestAnimationFrame(r));

                // Load in worker - UI stays responsive!
                await workerApi.loadJson(jsonText);

                showLoader('Preparing view...', '');
                await new Promise(r => requestAnimationFrame(r));

                // Use cached data from worker
                samples = workerApi.sampleIds;
                pipelines = workerApi.pipelineIds;

                document.getElementById('header-info').textContent =
                    `${workerApi.refName} (${workerApi.refLength.toLocaleString()} bp) | ${samples.length} samples | ${pipelines.length} pipelines`;

                // Set timestamp in footer
                const timestamp = workerApi.generatedAt;
                if (timestamp) {
                    const date = new Date(timestamp);
                    const dd = String(date.getDate()).padStart(2, '0');
                    const mm = String(date.getMonth() + 1).padStart(2, '0');
                    const yyyy = date.getFullYear();
                    const hh = String(date.getHours()).padStart(2, '0');
                    const mi = String(date.getMinutes()).padStart(2, '0');
                    const ss = String(date.getSeconds()).padStart(2, '0');
                    const formattedDate = `${dd}/${mm}/${yyyy} ${hh}:${mi}:${ss}`;
                    document.getElementById('report-timestamp').textContent =
                        `Report generated: ${formattedDate}`;
                }

                // Build UI progressively (loader hidden inside after core UI ready)
                await buildUIProgressively();

            } catch (error) {
                hideLoader();
                alert('Error loading demo 2: ' + error.message);
                console.error(error);
            }
        }
        window.loadDemo2 = loadDemo2;

        async function loadDemo3() {
            showLoader('Loading demo 3...', 'Fetching Brucella data');
            await new Promise(r => requestAnimationFrame(r));

            try {
                // Use JSON format (gaps_only mode makes it small enough)
                const response = await fetch('demo3.json.gz');
                if (!response.ok) throw new Error('Failed to fetch demo3 file');

                const compressedSize = parseInt(response.headers.get('content-length') || '0');
                showLoader('Downloading...', `${(compressedSize / 1024 / 1024).toFixed(1)} MB compressed`);
                await new Promise(r => requestAnimationFrame(r));
                const arrayBuffer = await response.arrayBuffer();

                showLoader('Decompressing...', '0 MB');
                const jsonText = await decompressGzip(arrayBuffer, (bytes) => {
                    showLoader('Decompressing...', `${(bytes / 1024 / 1024).toFixed(1)} MB`);
                });

                showLoader('Loading data...', `${(jsonText.length / 1024 / 1024).toFixed(1)} MB JSON`);
                await new Promise(r => requestAnimationFrame(r));

                await workerApi.loadJson(jsonText);

                showLoader('Preparing view...', '');
                await new Promise(r => requestAnimationFrame(r));

                samples = workerApi.sampleIds;
                pipelines = workerApi.pipelineIds;

                document.getElementById('header-info').textContent =
                    `${workerApi.refName} (${workerApi.refLength.toLocaleString()} bp) | ${samples.length} samples | ${pipelines.length} pipelines`;

                const timestamp = workerApi.generatedAt;
                if (timestamp) {
                    const date = new Date(timestamp);
                    const dd = String(date.getDate()).padStart(2, '0');
                    const mm = String(date.getMonth() + 1).padStart(2, '0');
                    const yyyy = date.getFullYear();
                    const hh = String(date.getHours()).padStart(2, '0');
                    const mi = String(date.getMinutes()).padStart(2, '0');
                    const ss = String(date.getSeconds()).padStart(2, '0');
                    const formattedDate = `${dd}/${mm}/${yyyy} ${hh}:${mi}:${ss}`;
                    document.getElementById('report-timestamp').textContent =
                        `Report generated: ${formattedDate}`;
                }

                await buildUIProgressively();

            } catch (error) {
                hideLoader();
                alert('Error loading demo 3: ' + error.message);
                console.error(error);
            }
        }
        window.loadDemo3 = loadDemo3;

        async function loadDemo4() {
            showLoader('Loading demo 4...', 'Fetching West Nile data');
            await new Promise(r => requestAnimationFrame(r));

            try {
                const response = await fetch('demo4.json.gz');
                if (!response.ok) throw new Error('Failed to fetch demo4 file');

                const compressedSize = parseInt(response.headers.get('content-length') || '0');
                showLoader('Downloading...', `${(compressedSize / 1024 / 1024).toFixed(1)} MB compressed`);
                await new Promise(r => requestAnimationFrame(r));
                const arrayBuffer = await response.arrayBuffer();

                showLoader('Decompressing...', '0 MB');
                const jsonText = await decompressGzipWithProgress(arrayBuffer, (bytes) => {
                    showLoader('Decompressing...', `${(bytes / 1024 / 1024).toFixed(1)} MB`);
                });

                showLoader('Loading data...', `${(jsonText.length / 1024 / 1024).toFixed(0)} MB (in background)`);
                await new Promise(r => requestAnimationFrame(r));

                await workerApi.loadJson(jsonText);

                showLoader('Preparing view...', '');
                await new Promise(r => requestAnimationFrame(r));

                samples = workerApi.sampleIds;
                pipelines = workerApi.pipelineIds;

                document.getElementById('header-info').textContent =
                    `${workerApi.refName} (${workerApi.refLength.toLocaleString()} bp) | ${samples.length} samples | ${pipelines.length} pipelines`;

                const timestamp = workerApi.generatedAt;
                if (timestamp) {
                    const date = new Date(timestamp);
                    const dd = String(date.getDate()).padStart(2, '0');
                    const mm = String(date.getMonth() + 1).padStart(2, '0');
                    const yyyy = date.getFullYear();
                    const hh = String(date.getHours()).padStart(2, '0');
                    const mi = String(date.getMinutes()).padStart(2, '0');
                    const ss = String(date.getSeconds()).padStart(2, '0');
                    const formattedDate = `${dd}/${mm}/${yyyy} ${hh}:${mi}:${ss}`;
                    document.getElementById('report-timestamp').textContent =
                        `Report generated: ${formattedDate}`;
                }

                await buildUIProgressively();

            } catch (error) {
                hideLoader();
                alert('Error loading demo 4: ' + error.message);
                console.error(error);
            }
        }
        window.loadDemo4 = loadDemo4;

        async function loadFile(file) {
            showLoader('Loading file...', `${(file.size / 1024 / 1024).toFixed(1)} MB`);
            await new Promise(r => requestAnimationFrame(r)); // Force repaint

            try {
                const isGzip = file.name.endsWith('.gz');
                const isBinary = isBinaryFormat(file.name);

                if (isBinary) {
                    // Binary (bincode) format - much faster to parse
                    showLoader('Decompressing...', '0 MB');
                    await new Promise(r => requestAnimationFrame(r));
                    const arrayBuffer = await file.arrayBuffer();

                    let binaryData;
                    if (isGzip) {
                        binaryData = await decompressGzipBinary(arrayBuffer, (bytes) => {
                            showLoader('Decompressing...', `${(bytes / 1024 / 1024).toFixed(1)} MB`);
                        });
                    } else {
                        binaryData = new Uint8Array(arrayBuffer);
                    }

                    showLoader('Loading data...', `${(binaryData.length / 1024 / 1024).toFixed(0)} MB (in background)`);
                    await new Promise(r => requestAnimationFrame(r));

                    // Load in worker - UI stays responsive!
                    await workerApi.loadBinary(binaryData.buffer);
                } else {
                    // JSON format
                    let text;
                    if (isGzip) {
                        showLoader('Decompressing...', '0 MB');
                        await new Promise(r => requestAnimationFrame(r));
                        const arrayBuffer = await file.arrayBuffer();

                        text = await decompressGzipWithProgress(arrayBuffer, (bytes) => {
                            showLoader('Decompressing...', `${(bytes / 1024 / 1024).toFixed(1)} MB`);
                        });
                    } else {
                        showLoader('Reading file...', '');
                        text = await file.text();
                    }

                    showLoader('Loading data...', `${(text.length / 1024 / 1024).toFixed(0)} MB (in background)`);
                    await new Promise(r => requestAnimationFrame(r));

                    // Load in worker - UI stays responsive!
                    await workerApi.loadJson(text);
                }

                showLoader('Preparing view...', '');
                await new Promise(r => requestAnimationFrame(r));

                // Use cached data from worker
                samples = workerApi.sampleIds;
                pipelines = workerApi.pipelineIds;

                document.getElementById('header-info').textContent =
                    `${workerApi.refName} (${workerApi.refLength.toLocaleString()} bp) | ${samples.length} samples | ${pipelines.length} pipelines`;

                // Set timestamp in footer (format: dd/mm/yyyy hh:mi:ss)
                const timestamp = workerApi.generatedAt;
                if (timestamp) {
                    const date = new Date(timestamp);
                    const dd = String(date.getDate()).padStart(2, '0');
                    const mm = String(date.getMonth() + 1).padStart(2, '0');
                    const yyyy = date.getFullYear();
                    const hh = String(date.getHours()).padStart(2, '0');
                    const mi = String(date.getMinutes()).padStart(2, '0');
                    const ss = String(date.getSeconds()).padStart(2, '0');
                    const formattedDate = `${dd}/${mm}/${yyyy} ${hh}:${mi}:${ss}`;
                    document.getElementById('report-timestamp').textContent =
                        `Report generated: ${formattedDate}`;
                }

                // Build UI progressively (loader hidden inside after core UI ready)
                await buildUIProgressively();

            } catch (err) {
                hideLoader();
                console.error('Failed to load report:', err);
                alert('Failed to load report: ' + err);
            }
        }

        function displayWarnings() {
            const warnings = workerApi.warnings || [];
            const container = document.getElementById('warnings');

            if (warnings.length === 0) {
                container.innerHTML = '';
                return;
            }

            let html = '';
            for (const warning of warnings) {
                // Skip MNP warnings - they're shown in the table with warning icon
                if (warning.includes('MNP')) {
                    continue;
                }
                html += `<div class="warning-item">${warning}</div>`;
            }
            container.innerHTML = html;
        }

        // Simple markdown renderer
        function renderMarkdown(text) {
            if (!text) return '';

            const lines = text.split('\n');
            let html = '';
            let inList = false;
            let inParagraph = false;
            let inCodeBlock = false;
            let codeBlockContent = [];
            let inTable = false;
            let tableRows = [];

            function applyInline(str) {
                return str
                    .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\*([^*]+)\*/g, '<em>$1</em>')
                    .replace(/_([^_]+)_/g, '<em>$1</em>')
                    .replace(/`([^`]+)`/g, '<code>$1</code>');
            }

            function closeOpenTags() {
                if (inParagraph) { html += '</p>'; inParagraph = false; }
                if (inList) { html += '</ul>'; inList = false; }
            }

            function renderTable() {
                if (tableRows.length < 2) return;
                let thtml = '<table class="md-table"><thead><tr>';
                const headers = tableRows[0].split('|').filter(c => c.trim());
                headers.forEach(h => thtml += `<th>${applyInline(h.trim())}</th>`);
                thtml += '</tr></thead><tbody>';
                for (let i = 2; i < tableRows.length; i++) {
                    const cells = tableRows[i].split('|').filter(c => c.trim());
                    thtml += '<tr>';
                    cells.forEach(c => thtml += `<td>${applyInline(c.trim())}</td>`);
                    thtml += '</tr>';
                }
                thtml += '</tbody></table>';
                html += thtml;
                tableRows = [];
                inTable = false;
            }

            for (let i = 0; i < lines.length; i++) {
                let line = lines[i];

                // Code block handling
                if (line.trim().startsWith('```')) {
                    if (inCodeBlock) {
                        html += '<pre><code>' + codeBlockContent.join('\n')
                            .replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</code></pre>';
                        codeBlockContent = [];
                        inCodeBlock = false;
                    } else {
                        closeOpenTags();
                        if (inTable) renderTable();
                        inCodeBlock = true;
                    }
                    continue;
                }
                if (inCodeBlock) {
                    codeBlockContent.push(line);
                    continue;
                }

                // Escape HTML for non-code
                line = line.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');

                // Table handling
                const isTableRow = /^\|.*\|$/.test(line.trim());
                const isSeparator = /^\|[-:\s|]+\|$/.test(line.trim());
                if (isTableRow || isSeparator) {
                    if (!inTable) {
                        closeOpenTags();
                        inTable = true;
                    }
                    tableRows.push(line.trim());
                    continue;
                } else if (inTable) {
                    renderTable();
                }

                const isHeader = /^#{1,3} /.test(line);
                const isListItem = /^[-*] /.test(line) || /^\d+\. /.test(line);
                const isEmpty = line.trim() === '';

                if (inParagraph && (isHeader || isListItem || isEmpty)) {
                    html += '</p>';
                    inParagraph = false;
                }
                if (inList && !isListItem) {
                    html += '</ul>';
                    inList = false;
                }
                if (isEmpty) continue;

                if (/^### (.+)$/.test(line)) {
                    html += line.replace(/^### (.+)$/, '<h3>' + '$1'.replace(/\*/g, '') + '</h3>').replace(/\*([^*]+)\*/g, '<em>$1</em>');
                } else if (/^## (.+)$/.test(line)) {
                    html += line.replace(/^## (.+)$/, '<h2>$1</h2>').replace(/\*([^*]+)\*/g, '<em>$1</em>');
                } else if (/^# (.+)$/.test(line)) {
                    html += line.replace(/^# (.+)$/, '<h1>$1</h1>').replace(/\*([^*]+)\*/g, '<em>$1</em>');
                } else if (isListItem) {
                    if (!inList) { html += '<ul>'; inList = true; }
                    let content = line.replace(/^[-*] /, '').replace(/^\d+\. /, '');
                    html += '<li>' + applyInline(content) + '</li>';
                } else {
                    if (!inParagraph) { html += '<p>'; inParagraph = true; }
                    else html += ' ';
                    html += applyInline(line);
                }
            }

            if (inCodeBlock) {
                html += '<pre><code>' + codeBlockContent.join('\n')
                    .replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</code></pre>';
            }
            if (inTable) renderTable();
            if (inParagraph) html += '</p>';
            if (inList) html += '</ul>';

            return html;
        }

        function populateDescription() {
            const panel = document.getElementById('description-panel');
            const view = document.getElementById('description-view');

            const description = workerApi.description;

            if (description && description.trim()) {
                panel.style.display = 'block';
                view.innerHTML = renderMarkdown(description);
            } else {
                // Hide panel if no description
                panel.style.display = 'none';
            }
        }

        function populateConfig() {
            const panel = document.getElementById('config-panel');
            const pre = document.getElementById('config-yaml');
            const yaml = workerApi.configYaml;
            if (yaml && yaml.trim()) {
                panel.style.display = 'block';
                pre.textContent = yaml;
            } else {
                panel.style.display = 'none';
            }
        }

        function populatePipelineInfo() {
            const pipelineIds = workerApi.pipelineIds;
            const container = document.getElementById('pipelines-info');

            let html = '';
            for (const pipelineId of pipelineIds) {
                const label = workerApi.getPipelineLabel(pipelineId);
                const command = workerApi.getPipelineCommand(pipelineId);
                const isReference = workerApi.isReference(pipelineId);
                const isFromBamPileup = workerApi.isFromBamPileup(pipelineId);

                html += `<div class="pipeline-info-item">`;
                html += `<div class="pipeline-name">${label}`;
                if (isReference) {
                    html += `<span class="pipeline-badge">Reference</span>`;
                    if (isFromBamPileup) {
                        html += `<span class="pipeline-badge" style="background:#ff9800;" title="SNPs derived from BAM pileup, no variant calling filters applied">BAM pileup</span>`;
                    }
                }
                html += `</div>`;
                if (command) {
                    html += `<div class="pipeline-command">${command}</div>`;
                }
                if (isReference && isFromBamPileup) {
                    html += `<div style="color:#ff9800;font-size:10px;margin-top:4px;">⚠️ SNPs from BAM pileup - no variant calling performed</div>`;
                }
                html += `</div>`;
            }

            if (html === '') {
                html = '<p style="color:var(--text-secondary);font-size:11px;">No pipeline information available.</p>';
            }

            container.innerHTML = html;
        }

        function copyToClipboard(button, text) {
            navigator.clipboard.writeText(text).then(() => {
                const originalText = button.textContent;
                button.textContent = 'Copied!';
                setTimeout(() => button.textContent = originalText, 1500);
            });
        }

        async function updateKPIs() {
            const kpis = await workerApi.getKpis();
            const refLength = workerApi.refLength;
            const gtPipelineId = workerApi.referencePipeline;

            // Helper to sort pipeline entries with GT always first, then alphabetically
            const sortedPipelineEntries = (obj) => {
                return Object.entries(obj).sort(([a], [b]) => {
                    if (a === gtPipelineId) return -1;
                    if (b === gtPipelineId) return 1;
                    return a.localeCompare(b);
                });
            };

            // Helper to create info icon
            const infoIcon = (type) => `<span class="info-icon" onclick="event.stopPropagation();showKpiInfo('${type}')">ⓘ</span>`;

            // Helper to create collapsible section
            const sectionStart = (title, open = false, extraClass = '') => `<details class="kpi-section${extraClass ? ' ' + extraClass : ''}"${open ? ' open' : ''}><summary>${title}</summary><div class="kpi-section-content">`;
            const sectionEnd = () => `</div></details>`;

            let html = '';

            // === Overview (standalone) ===
            html += sectionStart('Overview', true);
            html += `
                <div class="kpi"><div class="label">Reference ${infoIcon('reference')}</div><div class="value">${refLength.toLocaleString()} bp</div></div>
                <div class="kpi"><div class="label">Samples ${infoIcon('samples')}</div><div class="value">${kpis.samples}</div></div>
                <div class="kpi"><div class="label">Pipelines ${infoIcon('pipelines')}</div><div class="value">${kpis.pipelines}</div></div>
            `;
            html += sectionEnd();

            // === GT Pipeline KPIs (Gap-Intersect, Gap-Union, Pairwise) ===
            const pipelineInfo = workerApi.cachedData.pipelineInfo || {};
            if (gtPipelineId) {
                const gtLabel = (pipelineInfo[gtPipelineId] && pipelineInfo[gtPipelineId].label) || gtPipelineId;
                html += sectionStart(`${gtLabel} <span style="color:#e6862a;font-weight:bold;">(Reference)</span>`, true, 'has-children');
                if (workerApi.isFromBamPileup(gtPipelineId)) {
                    const opts = workerApi.pileupOptions;
                    let optsStr = '';
                    if (opts) {
                        optsStr = ` — min_depth: ${opts.min_depth}, min_consensus: ${opts.min_consensus}, min_qual: ${opts.min_qual}, include_indels: ${opts.include_indels}`;
                    }
                    html += `<div style="background:rgba(255,152,0,0.1);border-left:3px solid #ff9800;padding:6px 10px;margin-bottom:10px;font-size:10px;color:var(--text-secondary);border-radius:0 4px 4px 0;">
                        ⚠ Reference SNPs derived from <strong>BAM pileup</strong> (no variant calling performed). Positions with depth &lt; min_depth are gaps; bases are called by majority consensus.${optsStr}
                    </div>`;
                }
                html += `<div class="kpi-row">`;

                // Global stats
                const gs = await workerApi.getGlobalStatsForPipeline(gtPipelineId);
                if (gs) {
                    html += sectionStart(`Gap-Intersect ${infoIcon('gt_disc_gi')}`, true, 'bg-gi');
                    html += `<div class="kpi"><div class="label">Usable Space ${infoIcon('pp_gi_usable')}</div><div class="value">${gs.relaxed.usable_space.toLocaleString()} bp <span class="pct">(${gs.relaxed.usable_space_pct.toFixed(2)}%)</span></div></div>`;
                    html += `<button class="kpi-expand-btn" onclick="this.nextElementSibling.classList.toggle('expanded');this.textContent=this.textContent==='+'?'−':'+'">+</button>`;
                    html += `<div class="kpi-collapsible">`;
                    html += `<div class="kpi"><div class="label">Total SNPs ${infoIcon('pp_gi_total')}</div><div class="value">${gs.relaxed.total_snps.toLocaleString()}</div></div>`;
                    html += `<div class="kpi"><div class="label">Consensus SNPs ${infoIcon('pp_gi_consensus')}</div><div class="value">${gs.relaxed.consensus_snps.toLocaleString()}</div></div>`;
                    html += `</div>`;
                    html += `<div class="kpi"><div class="label">Discriminating SNPs ${infoIcon('pp_gi_disc')}</div><div class="value">${gs.relaxed.discriminating_snps.toLocaleString()}</div></div>`;
                    html += sectionEnd();

                    html += sectionStart(`Gap-Union ${infoIcon('gt_disc_gu')}`, true, 'bg-gu');
                    html += `<div class="kpi"><div class="label">Usable Space ${infoIcon('pp_gu_usable')}</div><div class="value">${gs.strict.usable_space.toLocaleString()} bp <span class="pct">(${gs.strict.usable_space_pct.toFixed(2)}%)</span></div></div>`;
                    html += `<button class="kpi-expand-btn" onclick="this.nextElementSibling.classList.toggle('expanded');this.textContent=this.textContent==='+'?'−':'+'">+</button>`;
                    html += `<div class="kpi-collapsible">`;
                    html += `<div class="kpi"><div class="label">Total SNPs ${infoIcon('pp_gu_total')}</div><div class="value">${gs.strict.total_snps.toLocaleString()}</div></div>`;
                    html += `<div class="kpi"><div class="label">Consensus SNPs ${infoIcon('pp_gu_consensus')}</div><div class="value">${gs.strict.consensus_snps.toLocaleString()}</div></div>`;
                    html += `</div>`;
                    html += `<div class="kpi"><div class="label">Discriminating SNPs ${infoIcon('pp_gu_disc')}</div><div class="value">${gs.strict.discriminating_snps.toLocaleString()}</div></div>`;
                    html += sectionEnd();
                }

                // Pairwise stats
                if (kpis.samples >= 2) {
                    const pw = await workerApi.getPairwiseUsableStatsForPipeline(gtPipelineId);
                    if (pw && pw.num_pairs > 0) {
                        html += sectionStart(`Pairwise (Gap-Union) ${infoIcon('gt_disc_pw')} <span style="font-weight:normal;font-size:10px;color:var(--text-muted);">(${pw.num_pairs} pairs)</span>`, true, 'bg-pw');
                        html += `<div class="kpi"><div class="label">Avg Usable Space ${infoIcon('pp_pw_usable')}</div><div class="value">${Math.round(pw.avg_usable_space).toLocaleString()} bp <span class="pct">(${pw.avg_usable_space_pct.toFixed(2)}%)</span></div></div>`;
                        html += `<div class="kpi"><div class="label">Discriminating SNPs ${infoIcon('pp_pw_disc')}</div><div class="value">avg ${pw.avg_usable_snps.toFixed(1)}</div></div>`;
                        html += `<button class="kpi-expand-btn" onclick="this.nextElementSibling.classList.toggle('expanded');this.textContent=this.textContent==='+'?'−':'+'">+</button>`;
                        html += `<div class="kpi-collapsible">`;
                        html += `<div class="kpi"><div class="label">Min</div><div class="value">${pw.min_usable_snps.toLocaleString()}</div></div>`;
                        html += `<div class="kpi"><div class="label">Median</div><div class="value">${pw.median_usable_snps.toFixed(1)}</div></div>`;
                        html += `<div class="kpi"><div class="label">Max</div><div class="value">${pw.max_usable_snps.toLocaleString()}</div></div>`;
                        html += `</div>`;
                        html += sectionEnd();
                    }
                }

                html += `</div>`; // close kpi-row

                // Per-sample pairwise table (collapsed by default, inside GT section)
                if (kpis.samples >= 2) {
                    const pw2 = await workerApi.getPairwiseUsableStatsForPipeline(gtPipelineId);
                    if (pw2 && pw2.per_sample && pw2.per_sample.length > 0) {
                        const allSamples = pw2.per_sample.map(s => ({ id: s.sample_id, label: s.sample_label }));
                        html += sectionStart(`Per-Sample Pairwise ${infoIcon('pp_ps_table')}`, false);
                        const refLen = workerApi.refLength;
                        const sepPs = 'border-left:2px solid var(--text-muted);';
                        html += `<table class="kpi-table"><thead><tr>
                            <th>Sample</th>`;
                        for (const s of allSamples) {
                            html += `<th>${s.label}</th>`;
                        }
                        html += `<th style="${sepPs}">Avg Usable Space</th>`;
                        html += `<th>Avg Disc. SNPs</th>`;
                        html += `</tr></thead><tbody>`;
                        for (const s of pw2.per_sample) {
                            html += `<tr><td>${s.sample_label}</td>`;
                            const pairMap = {};
                            if (s.pairs) s.pairs.forEach(p => { pairMap[p.other_sample] = p; });
                            for (const other of allSamples) {
                                if (other.id === s.sample_id) {
                                    html += `<td class="diagonal">—</td>`;
                                } else {
                                    const p = pairMap[other.id];
                                    const val = p ? p.disc_snps : '?';
                                    let cls = '';
                                    if (p) {
                                        if (p.disc_snps <= 5) cls = 'low-dist';
                                        else if (p.disc_snps <= 20) cls = 'medium-dist';
                                        else cls = 'high-dist';
                                    }
                                    if (p && p.usable_space != null) {
                                        const uPct = refLen > 0 ? ((p.usable_space / refLen) * 100).toFixed(2) : '0.00';
                                        html += `<td class="${cls}">${typeof val === 'number' ? val.toLocaleString() : val}<br><span class="pct">${p.usable_space.toLocaleString()} (${uPct}%)</span></td>`;
                                    } else {
                                        html += `<td class="${cls}">${typeof val === 'number' ? val.toLocaleString() : val}</td>`;
                                    }
                                }
                            }
                            const avgPct = refLen > 0 ? ((s.avg_usable_space / refLen) * 100).toFixed(2) : '0.00';
                            html += `<td style="${sepPs}">${Math.round(s.avg_usable_space).toLocaleString()} <span class="pct">(${avgPct}%)</span></td>`;
                            html += `<td>${s.avg_disc_snps.toFixed(1)}</td>`;
                            html += `</tr>`;
                        }
                        html += `</tbody></table>`;
                        html += sectionEnd();
                    }
                }

                html += sectionEnd(); // close GT pipeline section
            }

            // === GT Discriminating SNPs Lost by VCF Pipelines ===
            if (gtPipelineId && kpis.samples >= 2) {
                const gtDiscVsPl = await workerApi.getGtDiscVsPipelines();
                if (gtDiscVsPl && Object.keys(gtDiscVsPl).length > 0) {
                    html += sectionStart(`Ref Discriminating SNPs vs Pipelines ${infoIcon('gt_disc_vs_pl')}`, true, 'has-children');
                    const sep = 'border-left:2px solid var(--text-muted);';
                    html += `<table class="kpi-table fixed-cols">`;
                    html += `<colgroup><col style="width:7%"><col style="width:5%"><col span="4" style="width:6.5%"><col style="width:3%"><col span="4" style="width:6.5%"><col style="width:3%"><col span="2" style="width:10%"></colgroup>`;
                    html += `<thead><tr>
                        <th rowspan="2">Pipeline</th>
                        <th rowspan="2">Disc. SNPs ${infoIcon('pl_disc_snps')}</th>
                        <th colspan="5" class="bg-gi" style="text-align:center;${sep}">Gap-Intersect ${infoIcon('gt_disc_gi')}</th>
                        <th colspan="5" class="bg-gu" style="text-align:center;${sep}">Gap-Union ${infoIcon('gt_disc_gu')}</th>
                        <th colspan="2" class="bg-pw" style="text-align:center;${sep}">Pairwise ${infoIcon('gt_disc_pw')}</th>
                    </tr><tr>
                        <th class="bg-gi" style="${sep}">Same Pos</th><th class="bg-gi">Concordant</th><th class="bg-gi">In Ref Gaps</th><th class="bg-gi">Lost ${infoIcon('pl_lost_snps')}</th><th class="bg-gi"></th>
                        <th class="bg-gu" style="${sep}">Same Pos</th><th class="bg-gu">Concordant</th><th class="bg-gu">In Ref Gaps</th><th class="bg-gu">Lost ${infoIcon('pl_lost_snps')}</th><th class="bg-gu"></th>
                        <th class="bg-pw" style="${sep}">Same Pos (avg)</th><th class="bg-pw">Concordant (avg)</th>
                    </tr></thead><tbody>`;
                    for (const [plId, stats] of Object.entries(gtDiscVsPl)) {
                        const plLabel = (pipelineInfo[plId] && pipelineInfo[plId].label) || plId;
                        const giHasConc = stats.gap_intersect_concordant != null;
                        const giConcPct = giHasConc && stats.gap_intersect_same_pos > 0 ? ((stats.gap_intersect_concordant / stats.gap_intersect_same_pos) * 100).toFixed(1) : '0.0';
                        const guHasConc = stats.gap_union_concordant != null;
                        const guConcPct = guHasConc && stats.gap_union_same_pos > 0 ? ((stats.gap_union_concordant / stats.gap_union_same_pos) * 100).toFixed(1) : '0.0';
                        const pwHasConc = stats.pairwise_concordant_avg != null;
                        const pwConcPct = pwHasConc && stats.pairwise_same_pos_avg > 0 ? ((stats.pairwise_concordant_avg / stats.pairwise_same_pos_avg) * 100).toFixed(1) : '0.0';
                        const fmtConc = (val, pct, hasConc) => hasConc ? `${val.toLocaleString()} <span class="pct">(${pct}%)</span>` : 'N/A';
                        const plDiscSnps = stats.pl_discriminating_core_snps || 0;
                        const giLost = Math.max(0, plDiscSnps - stats.gap_intersect_same_pos - stats.gap_intersect_pl_snps_in_gt_gaps);
                        const guLost = Math.max(0, plDiscSnps - stats.gap_union_same_pos - stats.gap_union_pl_snps_in_gt_gaps);
                        const giLostPct = plDiscSnps > 0 ? ((giLost / plDiscSnps) * 100).toFixed(1) : '0.0';
                        const guLostPct = plDiscSnps > 0 ? ((guLost / plDiscSnps) * 100).toFixed(1) : '0.0';
                        const drillBtn = (plId, strat) => `<button class="drill-btn" onclick="event.stopPropagation();showGtDiscDetail('${plId}','${strat}','all')" title="View positions">&#x1F50D;</button>`;
                        html += `<tr>
                            <td>${plLabel}</td>
                            <td>${stats.pl_discriminating_core_snps != null ? plDiscSnps.toLocaleString() : 'N/A'}</td>
                            <td class="bg-gi" style="${sep}">${stats.gap_intersect_same_pos.toLocaleString()}</td>
                            <td class="bg-gi">${fmtConc(stats.gap_intersect_concordant, giConcPct, giHasConc)}</td>
                            <td class="bg-gi">${stats.gap_intersect_pl_snps_in_gt_gaps.toLocaleString()}</td>
                            <td class="bg-gi">${giLost.toLocaleString()} <span class="pct">(${giLostPct}%)</span></td>
                            <td class="bg-gi">${drillBtn(plId, 'gap_intersect')}</td>
                            <td class="bg-gu" style="${sep}">${stats.gap_union_same_pos.toLocaleString()}</td>
                            <td class="bg-gu">${fmtConc(stats.gap_union_concordant, guConcPct, guHasConc)}</td>
                            <td class="bg-gu">${stats.gap_union_pl_snps_in_gt_gaps.toLocaleString()}</td>
                            <td class="bg-gu">${guLost.toLocaleString()} <span class="pct">(${guLostPct}%)</span></td>
                            <td class="bg-gu">${drillBtn(plId, 'gap_union')}</td>
                            <td class="bg-pw" style="${sep}">${stats.pairwise_same_pos_avg.toFixed(1)}</td>
                            <td class="bg-pw">${pwHasConc ? `${stats.pairwise_concordant_avg.toFixed(1)} <span class="pct">(${pwConcPct}%)</span>` : 'N/A'}</td>
                        </tr>`;
                    }
                    html += `</tbody></table>`;
                    html += sectionEnd();
                }
            }

            document.getElementById('kpis').innerHTML = html;
        }


        // Store pipeline distance matrices
        let pipelineDistanceMatrices = {};

        function populateAllMatrices() {
            const matrixResult = document.getElementById('matrix-result');
            if (!matrixResult) return;

            try {
                pipelineDistanceMatrices = workerApi.pipelineDistanceMatrices;
            } catch (e) {
                pipelineDistanceMatrices = {};
            }

            let html = '';
            let hasAny = false;

            for (const pipelineId of pipelines) {
                const matrixData = pipelineDistanceMatrices[pipelineId];
                if (!matrixData) continue;
                hasAny = true;

                const pipelineLabel = workerApi.getPipelineLabel(pipelineId);
                const { samples: matrixSamples, matrix } = matrixData;
                const labels = matrixSamples.map(s => workerApi.getSampleLabel(s));

                html += `<div style="margin-bottom:16px;">`;
                html += `<div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;">`;
                html += `<p style="color:var(--accent);font-size:11px;margin:0;"><strong>${pipelineLabel}</strong></p>`;
                html += `<button class="filter-btn" onclick="exportDistanceMatrix('${pipelineId}','tsv')" title="Download as TSV">TSV</button>`;
                html += `<button class="filter-btn" onclick="exportDistanceMatrix('${pipelineId}','csv')" title="Download as CSV">CSV</button>`;
                html += `</div>`;
                html += '<div class="table-wrapper"><table class="distance-matrix-table"><thead><tr><th></th>';
                for (const label of labels) {
                    html += `<th>${label}</th>`;
                }
                html += '</tr></thead><tbody>';

                for (let i = 0; i < matrixSamples.length; i++) {
                    html += `<tr><th>${labels[i]}</th>`;
                    for (let j = 0; j < matrixSamples.length; j++) {
                        const dist = matrix[i][j];
                        let cellClass = 'diagonal';
                        if (i !== j) {
                            if (dist <= 5) cellClass = 'low-dist';
                            else if (dist <= 20) cellClass = 'medium-dist';
                            else cellClass = 'high-dist';
                        }
                        html += `<td class="${cellClass}">${dist}</td>`;
                    }
                    html += '</tr>';
                }
                html += '</tbody></table></div></div>';
            }

            if (!hasAny) {
                document.getElementById('distance-matrix-panel').style.display = 'none';
            } else {
                matrixResult.innerHTML = html;
            }
        }

        function exportDistanceMatrix(pipelineId, format) {
            const matrixData = pipelineDistanceMatrices[pipelineId];
            if (!matrixData) return;

            const { samples: matrixSamples, matrix } = matrixData;
            const labels = matrixSamples.map(s => workerApi.cachedData.sampleLabels[s] || s);
            const sep = format === 'csv' ? ',' : '\t';

            let content = sep + labels.join(sep) + '\n';
            for (let i = 0; i < matrixSamples.length; i++) {
                content += labels[i] + sep + matrix[i].join(sep) + '\n';
            }

            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const plLabel = (workerApi.cachedData.pipelineInfo[pipelineId]?.label || pipelineId).replace(/\s+/g, '_');
            a.download = `distance_matrix_${plLabel}.${format}`;
            a.click();
            URL.revokeObjectURL(url);
        }

        main();
    </script>
</body>
</html>
